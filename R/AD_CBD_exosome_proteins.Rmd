---
title: "AD CBD Exosome Proteins"
author:
  - name: "Emir Turkes [et2628@cumc.columbia.edu]"
  - name: "Columbia University"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
bibliography: "../AD-CBD-exosome-proteins.bib"
biblio-style: apalike
link-citations: true
output:
  html_document:
    code_folding: show
    number_sections: true
    theme: lumen
    highlight: haddock
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: false
knit:
  (function(inputFile, encoding) {
    rmarkdown::render(
      inputFile, encoding = encoding,
      output_file = "../results/AD-CBD-exosome-proteins-report.html")})
---

```{r, include = FALSE}
#    This file is part of AD-CBD-exosome-proteins.
#    Copyright (C) 2019  Emir Turkes
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
#    Emir Turkes can be contacted at emir.turkes@eturkes.com

knitr::opts_chunk$set(fig.width = 8.5, fig.height = 7)
```

<style type="text/css">
body {font-size: 16px;}
h1.title {font-size: 35px;}
h1 {font-size: 24px;}
h2 {font-size: 22px;}
h3 {font-size: 20px;}
.toc-content {padding-left: 0px; padding-right: 0px;}
div.tocify {width: 100%;}
.tocify-subheader .tocify-item {font-size: 0.95em; padding-left: 25px; text-indent: 0;}
div.main-container {max-width: none; width: 100%;}
</style>

*This is an in-depth analysis based using one or more cleaned datasets.*

The goal of this analysis is to compare exosome proteins between control, Alzheimer's Disease (AD), and Corticobasal Degeneration (CBD) samples.

Datasets used in this analysis include:

- Mass spectrometry data of exosome proteins analyzed with MaxQuant.

This analysis was performed in R except where noted.
The source code and instructions for rerunning the analysis can be found at [github.com/eturkes/AD-CBD-exosome-proteins](https://github.com/eturkes/AD-CBD-exosome-proteins).

# Final Results

**Read just the following sub-section for the final results of the analysis and a brief summary of the methods.**

# ~~~ Breakdown of Methods ~~~ {-}

**Sections from here to the end break down the methods used and are optional to read.**

We start by loading in any required packages and setting some global variables.

```{r}
packages <- c("conflicted", "DT", "data.table", "readxl", "pheatmap", "plyr")
invisible(suppressPackageStartupMessages(lapply(packages, library, character.only = TRUE)))

assets_dir <- file.path(getwd(), "..", "assets")
results_dir <- file.path(getwd(), "..", "results")

# Adds download buttons and exponential values.
datatable_custom <- function(dt) {
  datatable(
    dt,
    extensions = "Buttons", options = list(dom = "Blfrtip", buttons = list(
      "copy", "print",
      list(extend = "collection", buttons = c("csv", "excel", "pdf"), text = "Download")),
    rowCallback = JS(
      "function(row, data) {",
        "for (i = 1; i < data.length; i++) {",
          "if (data[i]>=1000 | data[i]<1000) {",
            "$('td:eq('+i+')', row).html(data[i].toExponential(2));}}}")))}
```

# Original Data

This section contains the original data received from the mass spec facility and was mainly processed using MaxQuant.

```{r}
AD_control <- data.table(read_excel(
  file.path(assets_dir, "max-quant", "AD_CONTROL_DIFFERENCE_08202019.xls"), na = "NaN"))
CBD_control <- data.table(read_excel(
  file.path(assets_dir, "max-quant", "CBD_CONTROL_DIFFERENCE_08202019.xls"), na = "NaN"))
AD_CBD <- data.table(read_excel(
  file.path(assets_dir, "max-quant", "AD_CDB_DIFFERENCE_08202019.xls"), na = "NaN"))
sets <- list(AD_control, CBD_control, AD_CBD)
rm(AD_control, CBD_control, AD_CBD)

datatable_custom(sets[[1]])
datatable_custom(sets[[2]])
datatable_custom(sets[[3]])
```

# Preliminary Cleaning

```{r}
sets <- lapply(sets, function(x) x[ , c(6, 3, 2)])
sets <- lapply(sets, function(x) rename(x, c("Gene names" = "Genes", "p value" = "p_value")))
sets[[1]] <- rename(sets[[1]], c("AD_Control fold diff" = "AD_Control_Fold_Change"))
sets[[2]] <- rename(sets[[2]], c("CBD_Control_Fold difference" = "CBD_Control_Fold_Change"))
sets[[3]] <- rename(sets[[3]], c("AD_CDB_FoldDifference" = "AD_CBD_Fold_Change"))
sets <- lapply(sets, function(x) x[!x$Genes == "", ])
sets <- lapply(sets, function(x) x[x$p_value < 0.05, ])
sets <- lapply(sets, function(x) x[order(-x[ , 2])])

datatable_custom(sets[[1]]) %>%
  formatStyle("Genes", `text-align` = "center")
datatable_custom(sets[[2]]) %>%
  formatStyle("Genes", `text-align` = "center")
datatable_custom(sets[[3]]) %>%
  formatStyle("Genes", `text-align` = "center")
```

# Overlapping Genes

```{r}
merged_set <- Reduce(function(...) merge(..., all = TRUE), list(
  sets[[2]][ , 1:2], sets[[3]][ , 1:2]), sets[[1]][ , 1:2])
merged_set <- merged_set[!(is.na(merged_set$Genes) | merged_set$Genes == ""), ]
merged_set[is.na(merged_set)] <- 0

AD_control <- head(merged_set[order(-merged_set$AD_Control_Fold_Change)], n = 10)
CBD_control <- head(merged_set[order(-merged_set$CBD_Control_Fold_Change)], n = 10)
AD_CBD <- head(merged_set[order(-merged_set$AD_CBD_Fold_Change)], n = 10)

genes <- merged_set$Genes
merged_set <- merged_set[ , 2:4]
rownames(merged_set) <- genes
datatable_custom(merged_set)

merged_top <- Reduce(function(...) merge(..., all = TRUE), list(
  CBD_control[ , c(1, 3)], AD_CBD[ , c(1, 4)]), AD_control[ , c(1, 2)])
merged_top <- merged_top[!(is.na(merged_top$Genes) | merged_top$Genes == ""), ]
merged_top[is.na(merged_top)] <- 0
top_genes <- merged_top$Genes
merged_top <- merged_top[ , 2:4]
rownames(merged_top) <- top_genes
datatable_custom(merged_top)

merged_top <- as.matrix(merged_top)
rownames(merged_top) <- top_genes
pheatmap(merged_top, scale = "row")
```
