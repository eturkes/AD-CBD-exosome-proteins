---
title: "AD CBD Exosome Proteins"
author:
  - name: "Emir Turkes [et2628@cumc.columbia.edu]"
  - name: "Columbia University"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
bibliography: "../AD-CBD-exosome-proteins.bib"
biblio-style: apalike
link-citations: true
output:
  html_document:
    code_folding: show
    number_sections: true
    theme: lumen
    highlight: haddock
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: false
knit:
  (function(inputFile, encoding) {
    rmarkdown::render(
      inputFile, encoding = encoding,
      output_file = "../results/AD-CBD-exosome-proteins-report.html")})
---

```{r, include = FALSE}
# Copyright 2019 Emir Turkes
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
#     http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

knitr::opts_chunk$set(fig.width = 8.5, fig.height = 7)
```

<style type="text/css">
body {font-size: 16px;}
h1.title {font-size: 35px;}
h1 {font-size: 24px;}
h2 {font-size: 22px;}
h3 {font-size: 20px;}
.toc-content {padding-left: 0px; padding-right: 0px;}
div.tocify {width: 100%;}
.tocify-subheader .tocify-item {font-size: 0.95em; padding-left: 25px; text-indent: 0;}
div.main-container {max-width: none; width: 100%;}
</style>

*This is a broad initial analysis that prepares and characterizes the data for use in other projects.*

The background for this data is as follows:

- Two replicates of control, Alzheimer's Disease (AD), and Corticobasal Degeneration (CBD) patient brain samples.
- Mass spectrometry data of exosome proteins analyzed with MaxQuant.

This analysis was performed in R except where noted.
The source code and instructions for rerunning the analysis can be found at [github.com/eturkes/AD-CBD-exosome-proteins](https://github.com/eturkes/AD-CBD-exosome-proteins).

# Final Results

**None available...yet!**

# ~~~ Breakdown of Methods ~~~ {-}

**Sections from here to the end break down the methods used and are optional to read.**

We start by loading in any required packages and setting some global variables.

```{r}
assets_dir <- file.path(getwd(), "..", "assets")
results_dir <- file.path(getwd(), "..", "results")

packages <- c("conflicted", "DT", "data.table", "readxl", "pheatmap", "plyr", "RColorBrewer")
invisible(suppressPackageStartupMessages(lapply(packages, library, character.only = TRUE)))

# Adds download buttons.
datatable_download <- function(dt) {
  datatable(
    dt,
    extensions = "Buttons", options = list(dom = "Blfrtip", buttons = list(
      "copy", "print",
      list(extend = "collection", buttons = c("csv", "excel", "pdf"), text = "Download"))))}

# Adds download buttons and exponential values.
datatable_download_exp <- function(dt) {
  datatable(
    dt,
    extensions = "Buttons", options = list(dom = "Blfrtip", buttons = list(
      "copy", "print",
      list(extend = "collection", buttons = c("csv", "excel", "pdf"), text = "Download")),
    rowCallback = JS(
      "function(row, data) {",
        "for (i = 1; i < data.length; i++) {",
          "if (data[i]>=1000 | data[i]<1000) {",
            "$('td:eq('+i+')', row).html(data[i].toExponential(2));}}}")))}
```

# Original Data {.tabset}

This section contains the original data received from the mass spec facility and was mainly processed using MaxQuant.

```{r}
AD_control <- data.table(read_excel(
  file.path(assets_dir, "max-quant", "AD_CONTROL_DIFFERENCE_08202019.xls"), na = "NaN"))
CBD_control <- data.table(read_excel(
  file.path(assets_dir, "max-quant", "CBD_CONTROL_DIFFERENCE_08202019.xls"), na = "NaN"))
AD_CBD <- data.table(read_excel(
  file.path(assets_dir, "max-quant", "AD_CDB_DIFFERENCE_08202019.xls"), na = "NaN"))
sets <- list(AD_control, CBD_control, AD_CBD)
```

## AD vs. Control

```{r}
datatable_download_exp(sets[[1]])
```

## CBD vs. Control

```{r}
datatable_download_exp(sets[[2]])
```

## AD vs. CBD

```{r}
datatable_download_exp(sets[[3]])
```

# Preliminary Cleaning {.tabset}

First, we clean up the data and apply a p-value cutoff at 0.05.

```{r}
sets <- lapply(sets, function(x) x[ , c(6, 3, 2)])
sets <- lapply(sets, function(x) rename(x, c("Gene names" = "Genes", "p value" = "p_value")))
sets[[1]] <- rename(sets[[1]], c("AD_Control fold diff" = "AD_Control_Fold_Change"))
sets[[2]] <- rename(sets[[2]], c("CBD_Control_Fold difference" = "CBD_Control_Fold_Change"))
sets[[3]] <- rename(sets[[3]], c("AD_CDB_FoldDifference" = "AD_CBD_Fold_Change"))

sets <- lapply(sets, function(x) x[x$p_value < 0.05, ])
sets <- lapply(sets, function(x) x[!duplicated(x$Genes) | !is.na(x$Genes) | !x$Genes == "", ])
sets <- lapply(sets, function(x) x[!is.na(x$Genes), ])
sets <- lapply(sets, function(x) x[!x$Genes == "", ])
sets <- lapply(sets, function(x) replace(x, is.na(x), as.double("NA"))) # Properly type remaining NA.
sets <- lapply(sets, function(x) x[order(-x[ , 2])]) # Order by fold change.
```

## AD vs. Control

```{r}
datatable_download_exp(sets[[1]]) %>%
  formatStyle("Genes", `text-align` = "center")
```

## CBD vs. Control

```{r}
datatable_download_exp(sets[[2]]) %>%
  formatStyle("Genes", `text-align` = "center")
```

## AD vs. CBD

```{r}
datatable_download_exp(sets[[3]]) %>%
  formatStyle("Genes", `text-align` = "center")
```

# Differential Expression

We start by characterizing the differential expression of proteins in our two treatment conditions and three datasets.
The data is log-transformed to summarize both positive and negative relationships.

```{r}
merged_set <- Reduce(function(...) merge(..., all = TRUE), list(
  sets[[1]][ , c(1, 2)], sets[[2]][ , c(1, 2)], sets[[3]][ , c(1, 2)]))
merged_set <- merged_set[!duplicated(merged_set$Genes), ]
merged_set <- merged_set[!is.na(merged_set$Genes), ]
merged_set <- merged_set[!merged_set$Genes == "", ]

merged_set$AD_Control_Fold_Change <- log2(merged_set$AD_Control_Fold_Change)
merged_set$CBD_Control_Fold_Change <- log2(merged_set$CBD_Control_Fold_Change)
merged_set$AD_CBD_Fold_Change <- log2(merged_set$AD_CBD_Fold_Change)
merged_set <- rename(merged_set, c(
  "AD_Control_Fold_Change" = "log2_AD_Control_Fold_Change",
  "CBD_Control_Fold_Change" = "log2_CBD_Control_Fold_Change",
  "AD_CBD_Fold_Change" = "log2_AD_CBD_Fold_Change"))

datatable_download(merged_set) %>%
  formatStyle("Genes", `text-align` = "center") %>%
  formatRound(columns = c(2:dim(merged_set)[2]), digits = 2)
```

To narrow down the data, we start by comparing the top 10 within-group differentially expressed proteins for each dataset.

## Positive + Negative

In order to capture both positive and negative relationships, we subset using the absolute value of the log2 fold changes.

```{r}
AD_control <- head(merged_set[order(-abs(merged_set$log2_AD_Control_Fold_Change))], n = 10)
CBD_control <- head(merged_set[order(-abs(merged_set$log2_CBD_Control_Fold_Change))], n = 10)
AD_CBD <- head(merged_set[order(-abs(merged_set$log2_AD_CBD_Fold_Change))], n = 10)

merged_top <- Reduce(function(...) merge(..., all = TRUE), list(
  AD_control[ , c(1, 2)], CBD_control[ , c(1, 3)], AD_CBD[ , c(1, 4)]))
merged_top <- merged_top[!duplicated(merged_top$Genes), ]
merged_top <- merged_top[!is.na(merged_top$Genes), ]
merged_top <- merged_top[!merged_top$Genes == "", ]

top_genes <- merged_top$Genes
merged_top <- merged_top[ , 2:4]
rownames(merged_top) <- top_genes
datatable_download(merged_top) %>%
  formatRound(columns = c(1:dim(merged_top)[2]), digits = 2)

# Use grey for 0 in color palette to indicate NA values.
merged_top <- replace(merged_top, is.na(merged_top), 0)
color <- colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(100)
color[50] <- "#DDDDDD"

# Generate heatmap, setting breaks to reveal NA values.
merged_top <- as.matrix(merged_top)
rownames(merged_top) <- top_genes
pheatmap(
  merged_top,
  angle_col = 315,
  color = color,
  breaks = c(
    seq(min(merged_top), -0.001, by = abs(min(merged_top)) / 50), 0,
    seq(0.001, max(merged_top), by = abs(max(merged_top)) / 50)))
```

## Positive Only

```{r}
AD_control <- head(merged_set[order(-merged_set$log2_AD_Control_Fold_Change)], n = 10)
CBD_control <- head(merged_set[order(-merged_set$log2_CBD_Control_Fold_Change)], n = 10)
AD_CBD <- head(merged_set[order(-merged_set$log2_AD_CBD_Fold_Change)], n = 10)

merged_top <- Reduce(function(...) merge(..., all = TRUE), list(
  AD_control[ , c(1, 2)], CBD_control[ , c(1, 3)], AD_CBD[ , c(1, 4)]))
merged_top <- merged_top[!duplicated(merged_top$Genes), ]
merged_top <- merged_top[!is.na(merged_top$Genes), ]
merged_top <- merged_top[!merged_top$Genes == "", ]

top_genes <- merged_top$Genes
merged_top <- merged_top[ , 2:4]
rownames(merged_top) <- top_genes
datatable_download(merged_top) %>%
  formatRound(columns = c(1:dim(merged_top)[2]), digits = 2)

# Use grey for 0 in color palette to indicate NA values.
merged_top <- replace(merged_top, is.na(merged_top), 0)
color <- colorRampPalette(rev(brewer.pal(n = 7, name = "Reds")))(100)
color[1] <- "#DDDDDD"

# Generate heatmap.
merged_top <- as.matrix(merged_top)
rownames(merged_top) <- top_genes
pheatmap(merged_top, angle_col = 315, color = color)
```

## Negative Only

```{r}
AD_control <- head(merged_set[order(merged_set$log2_AD_Control_Fold_Change)], n = 10)
CBD_control <- head(merged_set[order(merged_set$log2_CBD_Control_Fold_Change)], n = 10)
AD_CBD <- head(merged_set[order(merged_set$log2_AD_CBD_Fold_Change)], n = 10)

merged_top <- Reduce(function(...) merge(..., all = TRUE), list(
  AD_control[ , c(1, 2)], CBD_control[ , c(1, 3)], AD_CBD[ , c(1, 4)]))
merged_top <- merged_top[!duplicated(merged_top$Genes), ]
merged_top <- merged_top[!is.na(merged_top$Genes), ]
merged_top <- merged_top[!merged_top$Genes == "", ]

top_genes <- merged_top$Genes
merged_top <- merged_top[ , 2:4]
rownames(merged_top) <- top_genes
datatable_download(merged_top) %>%
  formatRound(columns = c(1:dim(merged_top)[2]), digits = 2)

# Use grey for 0 in color palette to indicate NA values.
merged_top <- replace(merged_top, is.na(merged_top), 0)
color <- colorRampPalette(rev(brewer.pal(n = 7, name = "Blues")))(100)
color[100] <- "#DDDDDD"

# Generate heatmap.
merged_top <- as.matrix(merged_top)
rownames(merged_top) <- top_genes
pheatmap(merged_top, angle_col = 315, color = color)
```

# References

This is the concluding section of the document.
Here we write relevant results to disk, output the `sessionInfo`, and create a bibliography for works cited.

```{r}
sessionInfo()
```
