---
title: "AD CBD Exosome Proteins"
author:
  - name: "Emir Turkes [et2628@cumc.columbia.edu]"
  - name: "Columbia University"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
bibliography: "../AD-CBD-exosome-proteins.bib"
biblio-style: apalike
link-citations: true
output:
  html_document:
    code_folding: show
    number_sections: true
    theme: lumen
    highlight: haddock
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: false
knit:
  (function(inputFile, encoding) {
    rmarkdown::render(
      inputFile, encoding = encoding,
      output_file = "../results/AD-CBD-exosome-proteins-report.html")})
---

```{r, include = FALSE}
# Copyright 2019 Emir Turkes
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
#     http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

knitr::opts_chunk$set(fig.width = 8.5, fig.height = 7)
```

<style type="text/css">
body {font-size: 16px;}
h1.title {font-size: 35px;}
h1 {font-size: 24px;}
h2 {font-size: 22px;}
h3 {font-size: 20px;}
.toc-content {padding-left: 0px; padding-right: 0px;}
div.tocify {width: 100%;}
.tocify-subheader .tocify-item {font-size: 0.95em; padding-left: 25px; text-indent: 0;}
div.main-container {max-width: none; width: 100%;}
</style>

*This is a broad initial analysis that prepares and characterizes the data for use in other projects.*

The background for this data is as follows:

- Two replicates of control, Alzheimer's Disease (AD), and Corticobasal Degeneration (CBD) patient brain samples.
- Mass spectrometry data of exosome proteins analyzed with MaxQuant.

This analysis was performed in R except where noted.
The source code and instructions for rerunning the analysis can be found at [github.com/eturkes/AD-CBD-exosome-proteins](https://github.com/eturkes/AD-CBD-exosome-proteins).

# Final Results

**None available...yet!**

# ~~~ Breakdown of Methods ~~~ {-}

**Sections from here to the end break down the methods used and are optional to read.**

We start by loading in any required packages and setting some global variables.

```{r}
assets_dir <- file.path(getwd(), "..", "assets")
results_dir <- file.path(getwd(), "..", "results")

packages <- c("conflicted", "DT", "data.table", "readxl", "pheatmap", "plyr")
invisible(suppressPackageStartupMessages(lapply(packages, library, character.only = TRUE)))

# Adds download buttons and exponential values.
datatable_custom <- function(dt) {
  datatable(
    dt,
    extensions = "Buttons", options = list(dom = "Blfrtip", buttons = list(
      "copy", "print",
      list(extend = "collection", buttons = c("csv", "excel", "pdf"), text = "Download")),
    rowCallback = JS(
      "function(row, data) {",
        "for (i = 1; i < data.length; i++) {",
          "if (data[i]>=1000 | data[i]<1000) {",
            "$('td:eq('+i+')', row).html(data[i].toExponential(2));}}}")))}
```

# Original Data

This section contains the original data received from the mass spec facility and was mainly processed using MaxQuant.

```{r}
AD_control <- data.table(read_excel(
  file.path(assets_dir, "max-quant", "AD_CONTROL_DIFFERENCE_08202019.xls"), na = "NaN"))
CBD_control <- data.table(read_excel(
  file.path(assets_dir, "max-quant", "CBD_CONTROL_DIFFERENCE_08202019.xls"), na = "NaN"))
AD_CBD <- data.table(read_excel(
  file.path(assets_dir, "max-quant", "AD_CDB_DIFFERENCE_08202019.xls"), na = "NaN"))
sets <- list(AD_control, CBD_control, AD_CBD)

datatable_custom(sets[[1]])
datatable_custom(sets[[2]])
datatable_custom(sets[[3]])
```

# Preliminary Cleaning

First, we do some very basic modifications that improve presentation of the table without any direct data manipulation.

```{r}
sets <- lapply(sets, function(x) x[ , c(6, 3, 2)])

sets <- lapply(sets, function(x) rename(x, c("Gene names" = "Genes", "p value" = "p_value")))
sets[[1]] <- rename(sets[[1]], c("AD_Control fold diff" = "AD_Control_Fold_Change"))
sets[[2]] <- rename(sets[[2]], c("CBD_Control_Fold difference" = "CBD_Control_Fold_Change"))
sets[[3]] <- rename(sets[[3]], c("AD_CDB_FoldDifference" = "AD_CBD_Fold_Change"))

sets <- lapply(sets, function(x) x[!x$Genes == "", ]) # Remove blank entries.
sets <- lapply(sets, function(x) x[order(-x[ , 2])]) # Order by fold change.

datatable_custom(sets[[1]]) %>%
  formatStyle("Genes", `text-align` = "center")
datatable_custom(sets[[2]]) %>%
  formatStyle("Genes", `text-align` = "center")
datatable_custom(sets[[3]]) %>%
  formatStyle("Genes", `text-align` = "center")
```

# Differential Expression

We start by characterizing the differential expression of proteins in our two treatment conditions and three datasets.

```{r}
sets <- lapply(sets, function(x) x[x$p_value < 0.05, ]) # Set p-value cutoff.

merged_set <- Reduce(function(...) merge(..., all = TRUE), list(
  sets[[2]][ , c(1, 2)], sets[[3]][ , c(1, 2)]), sets[[1]][ , c(1, 2)])
merged_set <- merged_set[!(is.na(merged_set$Genes) | merged_set$Genes == ""), ]
merged_set[is.na(merged_set)] <- 0 # Set all NA to 0 for easier manipulation.

# Data for the next chunk must be prepared here.
AD_control <- head(merged_set[order(-merged_set$AD_Control_Fold_Change)], n = 10)
CBD_control <- head(merged_set[order(-merged_set$CBD_Control_Fold_Change)], n = 10)
AD_CBD <- head(merged_set[order(-merged_set$AD_CBD_Fold_Change)], n = 10)

genes <- merged_set$Genes
merged_set <- merged_set[ , 2:4]
rownames(merged_set) <- genes
datatable_custom(merged_set)
```

We also compare the top 10 within-group differentially expressed proteins for each dataset.

```{r}
merged_top <- Reduce(function(...) merge(..., all = TRUE), list(
  CBD_control[ , c(1, 3)], AD_CBD[ , c(1, 4)]), AD_control[ , c(1, 2)])
merged_top <- merged_top[!(is.na(merged_top$Genes) | merged_top$Genes == ""), ]
merged_top[is.na(merged_top)] <- 0 # Set all NA to 0 for easier manipulation.
top_genes <- merged_top$Genes
merged_top <- merged_top[ , 2:4]
rownames(merged_top) <- top_genes
datatable_custom(merged_top)

# Visualize in a heatmap.
merged_top <- as.matrix(merged_top)
rownames(merged_top) <- top_genes
pheatmap(merged_top, scale = "row")
```

# References

This is the concluding section of the document.
Here we write relevant results to disk, output the `sessionInfo`, and create a bibliography for works cited.

```{r}
sessionInfo()
```
