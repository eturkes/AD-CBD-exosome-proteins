---
title: "N8 AD Fractions"
author:
  - name: "Emir Turkes and Stephanie Fowler"
date: '`r strftime(Sys.time(), "%B %d, %Y")`'
bibliography: "../AD-CBD-exosome-proteins.bib"
link-citations: true
output:
  html_document:
    code_folding: hide
    number_sections: true
    theme: lumen
    highlight: haddock
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: false
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(
    "..", "results", "N8-AD-fractions.html"
  ))})
---

<style type="text/css">
body {font-size: 16px;}
h1.title {font-size: 35px;}
h1 {font-size: 24px;}
h2 {font-size: 22px;}
h3 {font-size: 20px;}
.toc-content {padding-left: 0px; padding-right: 0px;}
div.tocify {width: 100%;}
.tocify-subheader .tocify-item {font-size: 0.95em; padding-left: 25px; text-indent: 0;}
.tocify-subheader .tocify-subheader .tocify-item {
  font-size: 0.95em; padding-left: 35px; text-indent: 0;
}
div.main-container {max-width: none; width: 100%;}
</style>

*This file is a part of [AD-CBD-exosome-proteins](https://github.com/eturkes/AD-CBD-exosome-proteins).*
*Please email for access.*

The data here will be referenced using the name `fractions`.
It is a label-free mass spec dataset consisting of 8 Alzheimer's Disease (AD) human brain tissue donors where extracellular vesicles (EVs) were isolated and fractionated into 8 fractions.
Each sample in the dataset represents a fraction from a single donor.

```{r}
# Some standard boilerplate.
# --------------------------
# Copyright 2019-2022 Emir Turkes, Stephanie Fowler, UK DRI at UCL, Columbia University Medical
# Center
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
#     http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# This section should be checked per document.
# --------------------------------------------
packages <- c(
  "conflicted", "circlize", "dplyr", "DEP", "SummarizedExperiment", "scales", "ggplot2", "DT",
  "ComplexHeatmap", "EnhancedVolcano", "GSEABase", "GSVA", "RColorBrewer", "limma", "tibble",
  "readxl", "khroma", "biomaRt"
)
invisible(suppressPackageStartupMessages(lapply(packages, library, character.only = TRUE)))
source(file.path("utils.R"))
conflict_prefer("rowMedians", "Biobase", quiet = TRUE)
conflict_prefer("which", "BiocGenerics", quiet = TRUE)
conflict_prefer("select", "dplyr", quiet = TRUE)
conflict_prefer("intersect", "base", quiet = TRUE)

data_name <- "oxford-ms-data-april-2022"
`%notin%` <- Negate(`%in%`)
# --------------------------------------------

# Everything else in this chunk remains generally unchanged.
# ----------------------------------------------------------
assets_dir <- file.path("..", "assets") # Backed up data.

cache_dir <- file.path("..", "tmp", "cache", data_name, "fractions")
if (!dir.exists(cache_dir)) {
  dir.create(cache_dir, recursive = TRUE)
}

knitr::opts_chunk$set(fig.width = 10, fig.height = 7, dpi = 300)
# ----------------------------------------------------------
# --------------------------
```

For the first pass, we perform the analysis without application of a scaling factor that accounts for different loading concentration of each fraction.

# Prep

Read in the data and organize into a `SummarizedExperiment` object.

```{r}
data <- read.delim(file.path(assets_dir, data_name, "20220404_DOB_AllPatients_v1.pg_matrix.tsv"))
tmp1 <- data[ , 1:5]
tmp2 <- as.data.frame(data[ , 6])
colnames(tmp2) <- colnames(data)[6]
tmp3 <- data[ , 7:14]
tmp4 <- data[ , 15:ncol(data)]
data <- cbind(tmp1, tmp3, tmp2, tmp4)
rm(tmp1, tmp2, tmp3, tmp4)

data2 <- read_xlsx(
  file.path(assets_dir, data_name, "20220405_MSQ2321_StephanieFowler_DOB_EV64.xlsx")
)
colnames(data) <- c(colnames(data)[1:5], colnames(data2)[5:ncol(data2)])
rm(data2)

remove <- which(data$Genes == "")
data <- data[-remove, ]

data$gene_names <- data$Genes
data <- make_unique(data, "gene_names", "Protein.Ids", ";")

LFQ_columns <- 6:69
data <- data[
  , c(
      1:5, (order(substring(colnames(data)[LFQ_columns], nchar(colnames(data))[LFQ_columns])) + 5),
      70:ncol(data)
    )
]

experimental_design <- data.frame(
  label = colnames(data)[6:69],
  condition = paste0(
    "Fraction ", substring(colnames(data)[LFQ_columns], nchar(colnames(data))[LFQ_columns])
  ),
  replicate = rep(1:8, 8),
  donor = sub(" .*", "", colnames(data)[6:69])
)

data <- make_se(data, LFQ_columns, experimental_design)
data

colour <- colour("vibrant")(7)
colour <- append("#DDAA33", colour)
colour <- colour[c(1, 2, 5, 3, 4, 7, 6, 8)]
names(colour) <- unique(sub("\\.", " ", data$condition))
```

**Unaltered data, already log2 transformed**

```{r}
datatable <- assay(data)
colnames(datatable) <- sub("\\.", " ", paste(data$condition, data$donor, sep = " "))

datatable_download(datatable)
```

# QC

We apply quality control to the data.

## Summary Statistics

Basic descriptions of the data such as distributions.
For now we just have a histogram.

```{r}
hist(assay(data), n = 100)
```

## Missing Value Removal

Here we remove proteins with too many missing values and mark those that are missing-not-at-random (MNAR) and missing-at-random (MAR) for imputation later.
The basic workflow is shown below:

![](../assets/figures/missing-value-removal.svg)

```{r}
# Step 1 in flowchart.
# Remove proteins missing entirely in one condition.
# # --------------------------------------------------
# discard <- which(is.na(rowMeans(assay(data)[ , which(data$condition == "Fraction.1")], TRUE)))
# data <- data[-discard, ]
# discard <- which(is.na(rowMeans(assay(data)[ , which(data$condition == "Fraction.2")], TRUE)))
# data <- data[-discard, ]
# discard <- which(is.na(rowMeans(assay(data)[ , which(data$condition == "Fraction.3")], TRUE)))
# data <- data[-discard, ]
# discard <- which(is.na(rowMeans(assay(data)[ , which(data$condition == "Fraction.4")], TRUE)))
# data <- data[-discard, ]
# discard <- which(is.na(rowMeans(assay(data)[ , which(data$condition == "Fraction.5")], TRUE)))
# data <- data[-discard, ]
# discard <- which(is.na(rowMeans(assay(data)[ , which(data$condition == "Fraction.6")], TRUE)))
# data <- data[-discard, ]
# discard <- which(is.na(rowMeans(assay(data)[ , which(data$condition == "Fraction.7")], TRUE)))
# data <- data[-discard, ]
# discard <- which(is.na(rowMeans(assay(data)[ , which(data$condition == "Fraction.8")], TRUE)))
# data <- data[-discard, ]

# rds <- file.path(cache_dir, "data_NA_replaced.rds")
# if (file.exists(rds)) {
#   data <- readRDS(rds)
# } else {
# 
#   min <- min(assay(data), na.rm = TRUE)
# 
#   for (fraction in unique(data$condition)) {
#     replace <- which(is.na(rowMeans(assay(data)[ , which(data$condition == fraction)], TRUE)))
#     set.seed(1)
#     col <- sample(which(data$condition == fraction), length(replace), TRUE)
#     for (i in seq_along(replace)) {
#       assay(data)[replace[i], col[i]] <- min
#     }
#   }
#   saveRDS(data, rds)
# }

rds <- file.path(cache_dir, "data_NA_replaced_by_fraction.rds")
if (file.exists(rds)) {
  data <- readRDS(rds)
} else {
  for (fraction in unique(data$condition)) {
    min <- min(assay(data)[ , which(data$condition == fraction)], na.rm = TRUE)
    replace <- which(is.na(rowMeans(assay(data)[ , which(data$condition == fraction)], TRUE)))
    set.seed(1)
    col <- sample(which(data$condition == fraction), length(replace), TRUE)
    for (i in seq_along(replace)) {
      assay(data)[replace[i], col[i]] <- min
    }
  }
  saveRDS(data, rds)
}
# --------------------------------------------------

complete_cases <- filter_proteins(data, "complete") # Keep another object with only complete values.

plot_numbers(data) + theme(axis.text.x = element_text(size = 7))
plot_frequency(data)
plot_detect(data)

# Step 2 of flowchart.
# Find intensity cutoff point at which MNAR becomes MAR by finding the inflection point of intensity
# where the proportion of proteins with missing values dramatically level off.
# We do this separately for each condition to reduce the bias of biologically relevant missing
# values.
# --------------------------------------------------------------------------------------------------
plot <- plot_detect_custom(data[ , which(data$condition == "Fraction.1")])
plot_data <- ggplot_build(plot)
F1_MNAR_cutoff <- 13.3
F1_MNAR_cutoff <- 14.9
cat(paste0("For Fraction 1.\nCutoff at ", F1_MNAR_cutoff))
plot + geom_vline(xintercept = F1_MNAR_cutoff)

plot <- plot_detect_custom(data[ , which(data$condition == "Fraction.2")])
plot_data <- ggplot_build(plot)
F2_MNAR_cutoff <- 13.6
F2_MNAR_cutoff <- 14.7
cat(paste0("For Fraction 2.\nCutoff at ", F2_MNAR_cutoff))
plot + geom_vline(xintercept = F2_MNAR_cutoff)

plot <- plot_detect_custom(data[ , which(data$condition == "Fraction.3")])
plot_data <- ggplot_build(plot)
F3_MNAR_cutoff <- 13.6
F3_MNAR_cutoff <- 14.9
cat(paste0("For Fraction 3.\nCutoff at ", F3_MNAR_cutoff))
plot + geom_vline(xintercept = F3_MNAR_cutoff)

plot <- plot_detect_custom(data[ , which(data$condition == "Fraction.4")])
plot_data <- ggplot_build(plot)
F4_MNAR_cutoff <- 13.3
F4_MNAR_cutoff <- 14.3
cat(paste0("For Fraction 4.\nCutoff at ", F4_MNAR_cutoff))
plot + geom_vline(xintercept = F4_MNAR_cutoff)

plot <- plot_detect_custom(data[ , which(data$condition == "Fraction.5")])
plot_data <- ggplot_build(plot)
F5_MNAR_cutoff <- 12.7
F5_MNAR_cutoff <- 14.6
cat(paste0("For Fraction 5.\nCutoff at ", F5_MNAR_cutoff))
plot + geom_vline(xintercept = F5_MNAR_cutoff)

plot <- plot_detect_custom(data[ , which(data$condition == "Fraction.6")])
plot_data <- ggplot_build(plot)
F6_MNAR_cutoff <- 12.9
F6_MNAR_cutoff <- 14.5
cat(paste0("For Fraction 6.\nCutoff at ", F6_MNAR_cutoff))
plot + geom_vline(xintercept = F6_MNAR_cutoff)

plot <- plot_detect_custom(data[ , which(data$condition == "Fraction.7")])
plot_data <- ggplot_build(plot)
F7_MNAR_cutoff <- 13.3
F7_MNAR_cutoff <- 15.3
cat(paste0("For Fraction 7.\nCutoff at ", F7_MNAR_cutoff))
plot + geom_vline(xintercept = F7_MNAR_cutoff)

plot <- plot_detect_custom(data[ , which(data$condition == "Fraction.8")])
plot_data <- ggplot_build(plot)
F8_MNAR_cutoff <- 15.6
F8_MNAR_cutoff <- 17.9
cat(paste0("For Fraction 8.\nCutoff at ", F8_MNAR_cutoff))
plot + geom_vline(xintercept = F8_MNAR_cutoff)
# --------------------------------------------------------------------------------------------------
```

```{r}
# Step 3 in flowchart.
# Order each condition by row means and select the last protein to be included as MNAR.
# We choose row means over medians because high expression outliers may be decent indication a
# protein is not MNAR.
# --------------------------------------------------------------------------------------------
F1_order <- order(rowMeans(assay(data)[ , which(data$condition == "Fraction.1")], TRUE))
data <- data[F1_order, ]
F1_MNAR <- names(
  which(rowMeans(assay(data)[ , which(data$condition == "Fraction.1")], TRUE) < F1_MNAR_cutoff)
)
# plot_missval_custom(data, F1_MNAR)

F2_order <- order(rowMeans(assay(data)[ , which(data$condition == "Fraction.2")], TRUE))
data <- data[F2_order, ]
F2_MNAR <- names(
  which(rowMeans(assay(data)[ , which(data$condition == "Fraction.2")], TRUE) < F2_MNAR_cutoff)
)
# plot_missval_custom(data, F2_MNAR)

F3_order <- order(rowMeans(assay(data)[ , which(data$condition == "Fraction.3")], TRUE))
data <- data[F3_order, ]
F3_MNAR <- names(
  which(rowMeans(assay(data)[ , which(data$condition == "Fraction.3")], TRUE) < F3_MNAR_cutoff)
)
# plot_missval_custom(data, F3_MNAR)

F4_order <- order(rowMeans(assay(data)[ , which(data$condition == "Fraction.4")], TRUE))
data <- data[F4_order, ]
F4_MNAR <- names(
  which(rowMeans(assay(data)[ , which(data$condition == "Fraction.4")], TRUE) < F4_MNAR_cutoff)
)
# plot_missval_custom(data, F4_MNAR)

F5_order <- order(rowMeans(assay(data)[ , which(data$condition == "Fraction.5")], TRUE))
data <- data[F5_order, ]
F5_MNAR <- names(
  which(rowMeans(assay(data)[ , which(data$condition == "Fraction.5")], TRUE) < F5_MNAR_cutoff)
)
# plot_missval_custom(data, F5_MNAR)

F6_order <- order(rowMeans(assay(data)[ , which(data$condition == "Fraction.6")], TRUE))
data <- data[F6_order, ]
F6_MNAR <- names(
  which(rowMeans(assay(data)[ , which(data$condition == "Fraction.6")], TRUE) < F6_MNAR_cutoff)
)
# plot_missval_custom(data, F6_MNAR)

F7_order <- order(rowMeans(assay(data)[ , which(data$condition == "Fraction.7")], TRUE))
data <- data[F7_order, ]
F7_MNAR <- names(
  which(rowMeans(assay(data)[ , which(data$condition == "Fraction.7")], TRUE) < F7_MNAR_cutoff)
)
# plot_missval_custom(data, F7_MNAR)

F8_order <- order(rowMeans(assay(data)[ , which(data$condition == "Fraction.8")], TRUE))
data <- data[F8_order, ]
F8_MNAR <- names(
  which(rowMeans(assay(data)[ , which(data$condition == "Fraction.8")], TRUE) < F8_MNAR_cutoff)
)
# plot_missval_custom(data, F8_MNAR)
# --------------------------------------------------------------------------------------------

# Step 4 in flowchart.
# In each condition, remove MAR (non-MNAR) proteins where the majority are missing.
# This has not been empirically tested, but we have found that MAR imputation with a majority of
# missing values leads to suspect imputation.
# MNAR imputation however, does not suffer from this limitation, and in fact it is logical that MNAR
# proteins would have a high number of missing values.
# --------------------------------------------------------------------------------------------------
F1_data <- data[ , which(data$condition == "Fraction.1")]
F1_data <- F1_data[rownames(F1_data) %notin% F1_MNAR, ]
missing_data <- assay(F1_data) %>% data.frame(.)
missing_data <- ifelse(is.na(missing_data), 0, 1)
discard <- which(rowSums(missing_data, TRUE) < 5) # TODO: Automate this.
F1_data <- F1_data[-discard, ]
print(paste0("Removed ", length(discard), " proteins from Fraction 1 group."))

F2_data <- data[ , which(data$condition == "Fraction.2")]
F2_data <- F2_data[rownames(F2_data) %notin% F2_MNAR, ]
missing_data <- assay(F2_data) %>% data.frame(.)
missing_data <- ifelse(is.na(missing_data), 0, 1)
discard <- which(rowSums(missing_data, TRUE) < 5) # TODO: Automate this.
F2_data <- F2_data[-discard, ]
print(paste0("Removed ", length(discard), " proteins from Fraction 2 group."))

F3_data <- data[ , which(data$condition == "Fraction.3")]
F3_data <- F3_data[rownames(F3_data) %notin% F3_MNAR, ]
missing_data <- assay(F3_data) %>% data.frame(.)
missing_data <- ifelse(is.na(missing_data), 0, 1)
discard <- which(rowSums(missing_data, TRUE) < 5) # TODO: Automate this.
F3_data <- F3_data[-discard, ]
print(paste0("Removed ", length(discard), " proteins from Fraction 3 group."))

F4_data <- data[ , which(data$condition == "Fraction.4")]
F4_data <- F4_data[rownames(F4_data) %notin% F4_MNAR, ]
missing_data <- assay(F4_data) %>% data.frame(.)
missing_data <- ifelse(is.na(missing_data), 0, 1)
discard <- which(rowSums(missing_data, TRUE) < 5) # TODO: Automate this.
F4_data <- F4_data[-discard, ]
print(paste0("Removed ", length(discard), " proteins from Fraction 4 group."))

F5_data <- data[ , which(data$condition == "Fraction.5")]
F5_data <- F5_data[rownames(F5_data) %notin% F5_MNAR, ]
missing_data <- assay(F5_data) %>% data.frame(.)
missing_data <- ifelse(is.na(missing_data), 0, 1)
discard <- which(rowSums(missing_data, TRUE) < 5) # TODO: Automate this.
F5_data <- F5_data[-discard, ]
print(paste0("Removed ", length(discard), " proteins from Fraction 5 group."))

F6_data <- data[ , which(data$condition == "Fraction.6")]
F6_data <- F6_data[rownames(F6_data) %notin% F6_MNAR, ]
missing_data <- assay(F6_data) %>% data.frame(.)
missing_data <- ifelse(is.na(missing_data), 0, 1)
discard <- which(rowSums(missing_data, TRUE) < 5) # TODO: Automate this.
F6_data <- F6_data[-discard, ]
print(paste0("Removed ", length(discard), " proteins from Fraction 6 group."))

F7_data <- data[ , which(data$condition == "Fraction.7")]
F7_data <- F7_data[rownames(F7_data) %notin% F7_MNAR, ]
missing_data <- assay(F7_data) %>% data.frame(.)
missing_data <- ifelse(is.na(missing_data), 0, 1)
discard <- which(rowSums(missing_data, TRUE) < 5) # TODO: Automate this.
F7_data <- F7_data[-discard, ]
print(paste0("Removed ", length(discard), " proteins from Fraction 7 group."))

F8_data <- data[ , which(data$condition == "Fraction.8")]
F8_data <- F8_data[rownames(F8_data) %notin% F8_MNAR, ]
missing_data <- assay(F8_data) %>% data.frame(.)
missing_data <- ifelse(is.na(missing_data), 0, 1)
discard <- which(rowSums(missing_data, TRUE) < 5) # TODO: Automate this.
F8_data <- F8_data[-discard, ]
print(paste0("Removed ", length(discard), " proteins from Fraction 8 group."))
# --------------------------------------------------------------------------------------------------

# Continuation of step 4 in flowchart.
# In order to ensure that all conditions have MAR proteins with majority non-missing values, we
# perform the unions below.
# For example, out of the proteins that pass this QC in the AD condition, or have no missing values,
# we only keep those that pass this QC, have no missing values, or are MNAR in the Control condition
# as well.
# --------------------------------------------------------------------------------------------------
F1_MAR <- rownames(F1_data)[
  rownames(F1_data) %in% F2_MNAR | rownames(F1_data) %in% rownames(F2_data)
]
F1_MAR <- unique(
  intersect(
    F1_MAR,
    rownames(F1_data)[
      rownames(F1_data) %in% F3_MNAR | rownames(F1_data) %in% rownames(F3_data)
    ]
  )
)
F1_MAR <- unique(
  intersect(
    F1_MAR,
    rownames(F1_data)[
      rownames(F1_data) %in% F4_MNAR | rownames(F1_data) %in% rownames(F4_data)
    ]
  )
)
F1_MAR <- unique(
  intersect(
    F1_MAR,
    rownames(F1_data)[
      rownames(F1_data) %in% F5_MNAR | rownames(F1_data) %in% rownames(F5_data)
    ]
  )
)
F1_MAR <- unique(
  intersect(
    F1_MAR,
    rownames(F1_data)[
      rownames(F1_data) %in% F6_MNAR | rownames(F1_data) %in% rownames(F6_data)
    ]
  )
)
F1_MAR <- unique(
  intersect(
    F1_MAR,
    rownames(F1_data)[
      rownames(F1_data) %in% F7_MNAR | rownames(F1_data) %in% rownames(F7_data)
    ]
  )
)
F1_MAR <- unique(
  intersect(
    F1_MAR,
    rownames(F1_data)[
      rownames(F1_data) %in% F8_MNAR | rownames(F1_data) %in% rownames(F8_data)
    ]
  )
)

F2_MAR <- rownames(F2_data)[
  rownames(F2_data) %in% F1_MNAR | rownames(F2_data) %in% rownames(F1_data)
]
F2_MAR <- unique(
  intersect(
    F2_MAR,
    rownames(F2_data)[
      rownames(F2_data) %in% F3_MNAR | rownames(F2_data) %in% rownames(F3_data)
    ]
  )
)
F2_MAR <- unique(
  intersect(
    F2_MAR,
    rownames(F2_data)[
      rownames(F2_data) %in% F4_MNAR | rownames(F2_data) %in% rownames(F4_data)
    ]
  )
)
F2_MAR <- unique(
  intersect(
    F2_MAR,
    rownames(F2_data)[
      rownames(F2_data) %in% F5_MNAR | rownames(F2_data) %in% rownames(F5_data)
    ]
  )
)
F2_MAR <- unique(
  intersect(
    F2_MAR,
    rownames(F2_data)[
      rownames(F2_data) %in% F6_MNAR | rownames(F2_data) %in% rownames(F6_data)
    ]
  )
)
F2_MAR <- unique(
  intersect(
    F2_MAR,
    rownames(F2_data)[
      rownames(F2_data) %in% F7_MNAR | rownames(F2_data) %in% rownames(F7_data)
    ]
  )
)
F2_MAR <- unique(
  intersect(
    F2_MAR,
    rownames(F2_data)[
      rownames(F2_data) %in% F8_MNAR | rownames(F2_data) %in% rownames(F8_data)
    ]
  )
)

F3_MAR <- rownames(F3_data)[
  rownames(F3_data) %in% F1_MNAR | rownames(F3_data) %in% rownames(F1_data)
]
F3_MAR <- unique(
  intersect(
    F3_MAR,
    rownames(F3_data)[
      rownames(F3_data) %in% F2_MNAR | rownames(F3_data) %in% rownames(F2_data)
    ]
  )
)
F3_MAR <- unique(
  intersect(
    F3_MAR,
    rownames(F3_data)[
      rownames(F3_data) %in% F4_MNAR | rownames(F3_data) %in% rownames(F4_data)
    ]
  )
)
F3_MAR <- unique(
  intersect(
    F3_MAR,
    rownames(F3_data)[
      rownames(F3_data) %in% F5_MNAR | rownames(F3_data) %in% rownames(F5_data)
    ]
  )
)
F3_MAR <- unique(
  intersect(
    F3_MAR,
    rownames(F3_data)[
      rownames(F3_data) %in% F6_MNAR | rownames(F3_data) %in% rownames(F6_data)
    ]
  )
)
F3_MAR <- unique(
  intersect(
    F3_MAR,
    rownames(F3_data)[
      rownames(F3_data) %in% F7_MNAR | rownames(F3_data) %in% rownames(F7_data)
    ]
  )
)
F3_MAR <- unique(
  intersect(
    F3_MAR,
    rownames(F3_data)[
      rownames(F3_data) %in% F8_MNAR | rownames(F3_data) %in% rownames(F8_data)
    ]
  )
)

F4_MAR <- rownames(F4_data)[
  rownames(F4_data) %in% F1_MNAR | rownames(F4_data) %in% rownames(F1_data)
]
F4_MAR <- unique(
  intersect(
    F4_MAR,
    rownames(F4_data)[
      rownames(F4_data) %in% F2_MNAR | rownames(F4_data) %in% rownames(F2_data)
    ]
  )
)
F4_MAR <- unique(
  intersect(
    F4_MAR,
    rownames(F4_data)[
      rownames(F4_data) %in% F3_MNAR | rownames(F4_data) %in% rownames(F3_data)
    ]
  )
)
F4_MAR <- unique(
  intersect(
    F4_MAR,
    rownames(F4_data)[
      rownames(F4_data) %in% F5_MNAR | rownames(F4_data) %in% rownames(F5_data)
    ]
  )
)
F4_MAR <- unique(
  intersect(
    F4_MAR,
    rownames(F4_data)[
      rownames(F4_data) %in% F6_MNAR | rownames(F4_data) %in% rownames(F6_data)
    ]
  )
)
F4_MAR <- unique(
  intersect(
    F4_MAR,
    rownames(F4_data)[
      rownames(F4_data) %in% F7_MNAR | rownames(F4_data) %in% rownames(F7_data)
    ]
  )
)
F4_MAR <- unique(
  intersect(
    F4_MAR,
    rownames(F4_data)[
      rownames(F4_data) %in% F8_MNAR | rownames(F4_data) %in% rownames(F8_data)
    ]
  )
)

F5_MAR <- rownames(F5_data)[
  rownames(F5_data) %in% F1_MNAR | rownames(F5_data) %in% rownames(F1_data)
]
F5_MAR <- unique(
  intersect(
    F5_MAR,
    rownames(F5_data)[
      rownames(F5_data) %in% F2_MNAR | rownames(F5_data) %in% rownames(F2_data)
    ]
  )
)
F5_MAR <- unique(
  intersect(
    F5_MAR,
    rownames(F5_data)[
      rownames(F5_data) %in% F3_MNAR | rownames(F5_data) %in% rownames(F3_data)
    ]
  )
)
F5_MAR <- unique(
  intersect(
    F5_MAR,
    rownames(F5_data)[
      rownames(F5_data) %in% F4_MNAR | rownames(F5_data) %in% rownames(F4_data)
    ]
  )
)
F5_MAR <- unique(
  intersect(
    F5_MAR,
    rownames(F5_data)[
      rownames(F5_data) %in% F6_MNAR | rownames(F5_data) %in% rownames(F6_data)
    ]
  )
)
F5_MAR <- unique(
  intersect(
    F5_MAR,
    rownames(F5_data)[
      rownames(F5_data) %in% F7_MNAR | rownames(F5_data) %in% rownames(F7_data)
    ]
  )
)
F5_MAR <- unique(
  intersect(
    F5_MAR,
    rownames(F5_data)[
      rownames(F5_data) %in% F8_MNAR | rownames(F5_data) %in% rownames(F8_data)
    ]
  )
)

F6_MAR <- rownames(F6_data)[
  rownames(F6_data) %in% F1_MNAR | rownames(F6_data) %in% rownames(F1_data)
]
F6_MAR <- unique(
  intersect(
    F6_MAR,
    rownames(F6_data)[
      rownames(F6_data) %in% F2_MNAR | rownames(F6_data) %in% rownames(F2_data)
    ]
  )
)
F6_MAR <- unique(
  intersect(
    F6_MAR,
    rownames(F6_data)[
      rownames(F6_data) %in% F3_MNAR | rownames(F6_data) %in% rownames(F3_data)
    ]
  )
)
F6_MAR <- unique(
  intersect(
    F6_MAR,
    rownames(F6_data)[
      rownames(F6_data) %in% F4_MNAR | rownames(F6_data) %in% rownames(F4_data)
    ]
  )
)
F6_MAR <- unique(
  intersect(
    F6_MAR,
    rownames(F6_data)[
      rownames(F6_data) %in% F5_MNAR | rownames(F6_data) %in% rownames(F5_data)
    ]
  )
)
F6_MAR <- unique(
  intersect(
    F6_MAR,
    rownames(F6_data)[
      rownames(F6_data) %in% F7_MNAR | rownames(F6_data) %in% rownames(F7_data)
    ]
  )
)
F6_MAR <- unique(
  intersect(
    F6_MAR,
    rownames(F6_data)[
      rownames(F6_data) %in% F8_MNAR | rownames(F6_data) %in% rownames(F8_data)
    ]
  )
)

F7_MAR <- rownames(F7_data)[
  rownames(F7_data) %in% F1_MNAR | rownames(F7_data) %in% rownames(F1_data)
]
F7_MAR <- unique(
  intersect(
    F7_MAR,
    rownames(F7_data)[
      rownames(F7_data) %in% F2_MNAR | rownames(F7_data) %in% rownames(F2_data)
    ]
  )
)
F7_MAR <- unique(
  intersect(
    F7_MAR,
    rownames(F7_data)[
      rownames(F7_data) %in% F3_MNAR | rownames(F7_data) %in% rownames(F3_data)
    ]
  )
)
F7_MAR <- unique(
  intersect(
    F7_MAR,
    rownames(F7_data)[
      rownames(F7_data) %in% F4_MNAR | rownames(F7_data) %in% rownames(F4_data)
    ]
  )
)
F7_MAR <- unique(
  intersect(
    F7_MAR,
    rownames(F7_data)[
      rownames(F7_data) %in% F5_MNAR | rownames(F7_data) %in% rownames(F5_data)
    ]
  )
)
F7_MAR <- unique(
  intersect(
    F7_MAR,
    rownames(F7_data)[
      rownames(F7_data) %in% F6_MNAR | rownames(F7_data) %in% rownames(F6_data)
    ]
  )
)
F7_MAR <- unique(
  intersect(
    F7_MAR,
    rownames(F7_data)[
      rownames(F7_data) %in% F8_MNAR | rownames(F7_data) %in% rownames(F8_data)
    ]
  )
)

F8_MAR <- rownames(F8_data)[
  rownames(F8_data) %in% F1_MNAR | rownames(F8_data) %in% rownames(F1_data)
]
F8_MAR <- unique(
  intersect(
    F8_MAR,
    rownames(F8_data)[
      rownames(F8_data) %in% F2_MNAR | rownames(F8_data) %in% rownames(F2_data)
    ]
  )
)
F8_MAR <- unique(
  intersect(
    F8_MAR,
    rownames(F8_data)[
      rownames(F8_data) %in% F3_MNAR | rownames(F8_data) %in% rownames(F3_data)
    ]
  )
)
F8_MAR <- unique(
  intersect(
    F8_MAR,
    rownames(F8_data)[
      rownames(F8_data) %in% F4_MNAR | rownames(F8_data) %in% rownames(F4_data)
    ]
  )
)
F8_MAR <- unique(
  intersect(
    F8_MAR,
    rownames(F8_data)[
      rownames(F8_data) %in% F5_MNAR | rownames(F8_data) %in% rownames(F5_data)
    ]
  )
)
F8_MAR <- unique(
  intersect(
    F8_MAR,
    rownames(F8_data)[
      rownames(F8_data) %in% F6_MNAR | rownames(F8_data) %in% rownames(F6_data)
    ]
  )
)
F8_MAR <- unique(
  intersect(
    F8_MAR,
    rownames(F8_data)[
      rownames(F8_data) %in% F7_MNAR | rownames(F8_data) %in% rownames(F7_data)
    ]
  )
)

rm(F1_data, F2_data, F3_data, F4_data, F5_data, F6_data, F7_data, F8_data)
MAR <- unique(append(F1_MAR, c(F2_MAR, F3_MAR, F4_MAR, F5_MAR, F6_MAR, F7_MAR, F8_MAR)))

F1_MNAR_passQC <- F1_MNAR[F1_MNAR %in% F2_MAR | F1_MNAR %in% F2_MNAR]
F1_MNAR_passQC <- intersect(F1_MNAR_passQC, F1_MNAR[F1_MNAR %in% F3_MAR | F1_MNAR %in% F3_MNAR])
F1_MNAR_passQC <- intersect(F1_MNAR_passQC, F1_MNAR[F1_MNAR %in% F4_MAR | F1_MNAR %in% F4_MNAR])
F1_MNAR_passQC <- intersect(F1_MNAR_passQC, F1_MNAR[F1_MNAR %in% F5_MAR | F1_MNAR %in% F5_MNAR])
F1_MNAR_passQC <- intersect(F1_MNAR_passQC, F1_MNAR[F1_MNAR %in% F6_MAR | F1_MNAR %in% F6_MNAR])
F1_MNAR_passQC <- intersect(F1_MNAR_passQC, F1_MNAR[F1_MNAR %in% F7_MAR | F1_MNAR %in% F7_MNAR])
F1_MNAR_passQC <- intersect(F1_MNAR_passQC, F1_MNAR[F1_MNAR %in% F8_MAR | F1_MNAR %in% F8_MNAR])

F2_MNAR_passQC <- F2_MNAR[F2_MNAR %in% F1_MAR | F2_MNAR %in% F1_MNAR]
F2_MNAR_passQC <- intersect(F2_MNAR_passQC, F2_MNAR[F2_MNAR %in% F3_MAR | F2_MNAR %in% F3_MNAR])
F2_MNAR_passQC <- intersect(F2_MNAR_passQC, F2_MNAR[F2_MNAR %in% F4_MAR | F2_MNAR %in% F4_MNAR])
F2_MNAR_passQC <- intersect(F2_MNAR_passQC, F2_MNAR[F2_MNAR %in% F5_MAR | F2_MNAR %in% F5_MNAR])
F2_MNAR_passQC <- intersect(F2_MNAR_passQC, F2_MNAR[F2_MNAR %in% F6_MAR | F2_MNAR %in% F6_MNAR])
F2_MNAR_passQC <- intersect(F2_MNAR_passQC, F2_MNAR[F2_MNAR %in% F7_MAR | F2_MNAR %in% F7_MNAR])
F2_MNAR_passQC <- intersect(F2_MNAR_passQC, F2_MNAR[F2_MNAR %in% F8_MAR | F2_MNAR %in% F8_MNAR])

F3_MNAR_passQC <- F3_MNAR[F3_MNAR %in% F1_MAR | F3_MNAR %in% F1_MNAR]
F3_MNAR_passQC <- intersect(F3_MNAR_passQC, F3_MNAR[F3_MNAR %in% F2_MAR | F3_MNAR %in% F2_MNAR])
F3_MNAR_passQC <- intersect(F3_MNAR_passQC, F3_MNAR[F3_MNAR %in% F4_MAR | F3_MNAR %in% F4_MNAR])
F3_MNAR_passQC <- intersect(F3_MNAR_passQC, F3_MNAR[F3_MNAR %in% F5_MAR | F3_MNAR %in% F5_MNAR])
F3_MNAR_passQC <- intersect(F3_MNAR_passQC, F3_MNAR[F3_MNAR %in% F6_MAR | F3_MNAR %in% F6_MNAR])
F3_MNAR_passQC <- intersect(F3_MNAR_passQC, F3_MNAR[F3_MNAR %in% F7_MAR | F3_MNAR %in% F7_MNAR])
F3_MNAR_passQC <- intersect(F3_MNAR_passQC, F3_MNAR[F3_MNAR %in% F8_MAR | F3_MNAR %in% F8_MNAR])

F4_MNAR_passQC <- F4_MNAR[F4_MNAR %in% F1_MAR | F4_MNAR %in% F1_MNAR]
F4_MNAR_passQC <- intersect(F4_MNAR_passQC, F4_MNAR[F4_MNAR %in% F2_MAR | F4_MNAR %in% F2_MNAR])
F4_MNAR_passQC <- intersect(F4_MNAR_passQC, F4_MNAR[F4_MNAR %in% F3_MAR | F4_MNAR %in% F3_MNAR])
F4_MNAR_passQC <- intersect(F4_MNAR_passQC, F4_MNAR[F4_MNAR %in% F5_MAR | F4_MNAR %in% F5_MNAR])
F4_MNAR_passQC <- intersect(F4_MNAR_passQC, F4_MNAR[F4_MNAR %in% F6_MAR | F4_MNAR %in% F6_MNAR])
F4_MNAR_passQC <- intersect(F4_MNAR_passQC, F4_MNAR[F4_MNAR %in% F7_MAR | F4_MNAR %in% F7_MNAR])
F4_MNAR_passQC <- intersect(F4_MNAR_passQC, F4_MNAR[F4_MNAR %in% F8_MAR | F4_MNAR %in% F8_MNAR])

F5_MNAR_passQC <- F5_MNAR[F5_MNAR %in% F1_MAR | F5_MNAR %in% F1_MNAR]
F5_MNAR_passQC <- intersect(F5_MNAR_passQC, F5_MNAR[F5_MNAR %in% F2_MAR | F5_MNAR %in% F2_MNAR])
F5_MNAR_passQC <- intersect(F5_MNAR_passQC, F5_MNAR[F5_MNAR %in% F3_MAR | F5_MNAR %in% F3_MNAR])
F5_MNAR_passQC <- intersect(F5_MNAR_passQC, F5_MNAR[F5_MNAR %in% F4_MAR | F5_MNAR %in% F4_MNAR])
F5_MNAR_passQC <- intersect(F5_MNAR_passQC, F5_MNAR[F5_MNAR %in% F6_MAR | F5_MNAR %in% F6_MNAR])
F5_MNAR_passQC <- intersect(F5_MNAR_passQC, F5_MNAR[F5_MNAR %in% F7_MAR | F5_MNAR %in% F7_MNAR])
F5_MNAR_passQC <- intersect(F5_MNAR_passQC, F5_MNAR[F5_MNAR %in% F8_MAR | F5_MNAR %in% F8_MNAR])

F6_MNAR_passQC <- F6_MNAR[F6_MNAR %in% F1_MAR | F6_MNAR %in% F1_MNAR]
F6_MNAR_passQC <- intersect(F6_MNAR_passQC, F6_MNAR[F6_MNAR %in% F2_MAR | F6_MNAR %in% F2_MNAR])
F6_MNAR_passQC <- intersect(F6_MNAR_passQC, F6_MNAR[F6_MNAR %in% F3_MAR | F6_MNAR %in% F3_MNAR])
F6_MNAR_passQC <- intersect(F6_MNAR_passQC, F6_MNAR[F6_MNAR %in% F4_MAR | F6_MNAR %in% F4_MNAR])
F6_MNAR_passQC <- intersect(F6_MNAR_passQC, F6_MNAR[F6_MNAR %in% F5_MAR | F6_MNAR %in% F5_MNAR])
F6_MNAR_passQC <- intersect(F6_MNAR_passQC, F6_MNAR[F6_MNAR %in% F7_MAR | F6_MNAR %in% F7_MNAR])
F6_MNAR_passQC <- intersect(F6_MNAR_passQC, F6_MNAR[F6_MNAR %in% F8_MAR | F6_MNAR %in% F8_MNAR])

F7_MNAR_passQC <- F7_MNAR[F7_MNAR %in% F1_MAR | F7_MNAR %in% F1_MNAR]
F7_MNAR_passQC <- intersect(F7_MNAR_passQC, F7_MNAR[F7_MNAR %in% F2_MAR | F7_MNAR %in% F2_MNAR])
F7_MNAR_passQC <- intersect(F7_MNAR_passQC, F7_MNAR[F7_MNAR %in% F3_MAR | F7_MNAR %in% F3_MNAR])
F7_MNAR_passQC <- intersect(F7_MNAR_passQC, F7_MNAR[F7_MNAR %in% F4_MAR | F7_MNAR %in% F4_MNAR])
F7_MNAR_passQC <- intersect(F7_MNAR_passQC, F7_MNAR[F7_MNAR %in% F5_MAR | F7_MNAR %in% F5_MNAR])
F7_MNAR_passQC <- intersect(F7_MNAR_passQC, F7_MNAR[F7_MNAR %in% F6_MAR | F7_MNAR %in% F6_MNAR])
F7_MNAR_passQC <- intersect(F7_MNAR_passQC, F7_MNAR[F7_MNAR %in% F8_MAR | F7_MNAR %in% F8_MNAR])

F8_MNAR_passQC <- F8_MNAR[F8_MNAR %in% F1_MAR | F8_MNAR %in% F1_MNAR]
F8_MNAR_passQC <- intersect(F8_MNAR_passQC, F8_MNAR[F8_MNAR %in% F2_MAR | F8_MNAR %in% F2_MNAR])
F8_MNAR_passQC <- intersect(F8_MNAR_passQC, F8_MNAR[F8_MNAR %in% F3_MAR | F8_MNAR %in% F3_MNAR])
F8_MNAR_passQC <- intersect(F8_MNAR_passQC, F8_MNAR[F8_MNAR %in% F4_MAR | F8_MNAR %in% F4_MNAR])
F8_MNAR_passQC <- intersect(F8_MNAR_passQC, F8_MNAR[F8_MNAR %in% F5_MAR | F8_MNAR %in% F5_MNAR])
F8_MNAR_passQC <- intersect(F8_MNAR_passQC, F8_MNAR[F8_MNAR %in% F6_MAR | F8_MNAR %in% F6_MNAR])
F8_MNAR_passQC <- intersect(F8_MNAR_passQC, F8_MNAR[F8_MNAR %in% F7_MAR | F8_MNAR %in% F7_MNAR])

MNAR <- unique(
  append(
    F1_MNAR_passQC,
    c(
      F2_MNAR_passQC, F3_MNAR_passQC, F4_MNAR_passQC, F5_MNAR_passQC,
      F6_MNAR_passQC, F7_MNAR_passQC, F8_MNAR_passQC
    )
  )
)
# --------------------------------------------------------------------------------------------------

# Step 5 (last step) in flowchart.
# We join MAR and MNAR lists and subset the data.
# -----------------------------------------------
keep <- unique(append(MAR, MNAR))
data <- data[rownames(data) %in% keep, ]
# -----------------------------------------------

# Save some orders/subsets for later use.
# ---------------------------------------
data <- data[sort(rownames(data)), ]
F1_order <- order(rowMeans(assay(data)[ , which(data$condition == "Fraction.1")], TRUE))
F2_order <- order(rowMeans(assay(data)[ , which(data$condition == "Fraction.2")], TRUE))
F3_order <- order(rowMeans(assay(data)[ , which(data$condition == "Fraction.3")], TRUE))
F4_order <- order(rowMeans(assay(data)[ , which(data$condition == "Fraction.4")], TRUE))
F5_order <- order(rowMeans(assay(data)[ , which(data$condition == "Fraction.5")], TRUE))
F6_order <- order(rowMeans(assay(data)[ , which(data$condition == "Fraction.6")], TRUE))
F7_order <- order(rowMeans(assay(data)[ , which(data$condition == "Fraction.7")], TRUE))
F8_order <- order(rowMeans(assay(data)[ , which(data$condition == "Fraction.8")], TRUE))
missing_data <- assay(data) %>% data.frame(.)
missing_data <- missing_data[apply(missing_data, 1, function(x) any(is.na(x))), ]
# ---------------------------------------
```

```{r}
plot_numbers(data) + theme(axis.text.x = element_text(size = 7))
plot_frequency(data)
plot_detect(data)
```

## Normalization

Here we perform VSN normalization.

```{r}
# Normalize using VSN.
# We also create several extra variables for better plotting labels.
# ------------------------------------------------------------------
VSN_Normalized <- normalize_vsn(data)
Log_Transform_Only <- data

VSN_Normalized_Non_Missing_Data <- normalize_vsn(complete_cases)
Log_Transform_Only_Non_Missing_Data <- complete_cases
# ------------------------------------------------------------------

# Display results of normalization.
# ---------------------------------
print("Log_Transform_Only")
meanSdPlot(Log_Transform_Only)
print("Log_Transform_Only_Non_Missing_Data")
meanSdPlot(Log_Transform_Only_Non_Missing_Data)
print("VSN_Normalized")
meanSdPlot(VSN_Normalized)
print("VSN_Normalized_Non_Missing_Data")
meanSdPlot(VSN_Normalized_Non_Missing_Data)

plot_normalization(Log_Transform_Only, VSN_Normalized) + theme(axis.text.y = element_text(size = 3))
plot_normalization(Log_Transform_Only_Non_Missing_Data, VSN_Normalized_Non_Missing_Data) +
  theme(axis.text.y = element_text(size = 3))
# ---------------------------------

# Move normalized data to main objects and clean up.
# --------------------------------------------------
data <- VSN_Normalized
complete_cases <- VSN_Normalized_Non_Missing_Data
rm(
  VSN_Normalized, VSN_Normalized_Non_Missing_Data,
  Log_Transform_Only, Log_Transform_Only_Non_Missing_Data
)
# --------------------------------------------------
```

## Missing Value Imputation

Here we impute missing values using both MAR (`knn`) and MNAR methods (`MinProb`).

```{r}
# We create several extra variables for better plotting labels.
# -------------------------------------------------------------
unimputed_data <- data
Unimputed_Data <- unimputed_data
Non_Missing_data <- complete_cases
# -------------------------------------------------------------

plot_imputation(Unimputed_Data, Non_Missing_data)

# The main imputation code.
# -------------------------
impute1 <- data[ , which(data$condition == "Fraction.1")]
impute_vector <- rownames(impute1) %in% F1_MNAR # Logical vector specifying MNAR.
set.seed(1)
impute1 <- impute(impute1, "mixed", randna = !impute_vector, mar = "knn", mnar = "MinProb")

impute2 <- data[ , which(data$condition == "Fraction.2")]
impute_vector <- rownames(impute2) %in% F2_MNAR # Logical vector specifying MNAR.
set.seed(1)
impute2 <- impute(impute2, "mixed", randna = !impute_vector, mar = "knn", mnar = "MinProb")

impute3 <- data[ , which(data$condition == "Fraction.3")]
impute_vector <- rownames(impute3) %in% F3_MNAR # Logical vector specifying MNAR.
set.seed(1)
impute3 <- impute(impute3, "mixed", randna = !impute_vector, mar = "knn", mnar = "MinProb")

impute4 <- data[ , which(data$condition == "Fraction.4")]
impute_vector <- rownames(impute4) %in% F4_MNAR # Logical vector specifying MNAR.
set.seed(1)
impute4 <- impute(impute4, "mixed", randna = !impute_vector, mar = "knn", mnar = "MinProb")

impute5 <- data[ , which(data$condition == "Fraction.5")]
impute_vector <- rownames(impute5) %in% F5_MNAR # Logical vector specifying MNAR.
set.seed(1)
impute5 <- impute(impute5, "mixed", randna = !impute_vector, mar = "knn", mnar = "MinProb")

impute6 <- data[ , which(data$condition == "Fraction.6")]
impute_vector <- rownames(impute6) %in% F6_MNAR # Logical vector specifying MNAR.
set.seed(1)
impute6 <- impute(impute6, "mixed", randna = !impute_vector, mar = "knn", mnar = "MinProb")

impute7 <- data[ , which(data$condition == "Fraction.7")]
impute_vector <- rownames(impute7) %in% F7_MNAR # Logical vector specifying MNAR.
set.seed(1)
impute7 <- impute(impute7, "mixed", randna = !impute_vector, mar = "knn", mnar = "MinProb")

impute8 <- data[ , which(data$condition == "Fraction.8")]
impute_vector <- rownames(impute8) %in% F8_MNAR # Logical vector specifying MNAR.
set.seed(1)
impute8 <- impute(impute8, "mixed", randna = !impute_vector, mar = "knn", mnar = "MinProb")
# -------------------------

# Move imputed data to main objects and clean up.
# -----------------------------------------------
Imputed_Data <- data
assay(Imputed_Data, withDimnames = FALSE) <- cbind(
  assay(impute1), assay(impute2), assay(impute3), assay(impute4),
  assay(impute5), assay(impute6), assay(impute7), assay(impute8)
)
rm(impute1, impute2, impute3, impute4, impute5, impute6, impute7, impute8, Non_Missing_data)
data <- Imputed_Data
# -----------------------------------------------

plot_imputation(Imputed_Data)
```

```{r}
# Create a few more plots.
# ------------------------
plot_normalization(Unimputed_Data, Imputed_Data) + theme(axis.text.y = element_text(size = 3))

print("Unimputed Data")
meanSdPlot(Unimputed_Data)
print("Imputed Data")
meanSdPlot(Imputed_Data)
# ------------------------

rm(Imputed_Data, Unimputed_Data)
```

**Data after missing value imputation**
**This is final form used for differential expression analysis**

```{r}
datatable <- assay(data)
colnames(datatable) <- sub("\\.", " ", paste(data$condition, data$donor, sep = " "))

datatable_download(datatable)
```

## PCA

**Using all proteins.**

```{r, dev = "svglite"}
pca <- prcomp(t(assay(data)))
df <- as.data.frame(predict(pca)[ , 1:2])
df$Fraction <- sub("\\.", " ", data$condition)
df$Donor <- data$donor
summary <- summary(pca)$importance

ggplot(df, aes(PC1, PC2, color = Fraction)) +
  geom_point(aes(shape = Donor), size = 2, stroke = 1) +
  theme_bw() +
  geom_polygon(stat = "ellipse", aes(fill = Fraction), alpha = 0.05, level = 0.5, type = "norm") +
  labs(
    x = paste0("PC1: ", round(summary[2, 1] * 100, 1), "% of Variance Explained"),
    y = paste0("PC2: ", round(summary[2, 2] * 100, 1), "% of Variance Explained")
  ) +
  scale_shape_manual(values = seq_along(df$Donor)) +
  scale_fill_manual(values = colour) +
  scale_colour_manual(values = colour) +
  theme(axis.title = element_text(size = 16))
```

**Using complete cases only.**

```{r}
pca <- prcomp(t(assay(complete_cases)))
df <- as.data.frame(predict(pca)[ , 1:2])
df$Fraction <- sub("\\.", " ", complete_cases$condition)
df$Donor <- complete_cases$donor
summary <- summary(pca)$importance

ggplot(df, aes(PC1, PC2, color = Fraction)) +
  geom_point(aes(shape = Donor), size = 2, stroke = 2) +
  theme_bw() +
  geom_polygon(stat = "ellipse", aes(fill = Fraction), alpha = 0.05) +
  labs(
    x = paste0("PC1: ", round(summary[2, 1] * 100, 1), "% of Variance Explained"),
    y = paste0("PC2: ", round(summary[2, 2] * 100, 1), "% of Variance Explained")
  ) +
  scale_shape_manual(values = seq_along(df$Donor)) +
  scale_fill_manual(values = colour) +
  scale_colour_manual(values = colour) +
  theme(axis.title = element_text(size = 16))
```

# Differential Expression

Here we test for differential expression using `limma` (currently through the `DEP` package) and plot the results.
We filter using a log2 fold change cutoff of 1 and a 0.05 p-value cutoff after BH multiple testing correction.

```{r}
# Perform the DE testing.
# -----------------------
data_results <- add_rejections(test_diff(data, "all"))
results <- get_results(data_results)
# -----------------------

# sig_list <- vector("list", 8)
# sig_list[[1]] <- results[
#   which(rowSums(results[ , grep("Fraction.1", colnames(results)[31:58]) + 30] < 0.05) > 1),
# ]$name
# sig_list[[2]] <- results[
#   which(rowSums(results[ , grep("Fraction.2", colnames(results)[31:58]) + 30] < 0.05) > 1),
# ]$name
# sig_list[[3]] <- results[
#   which(rowSums(results[ , grep("Fraction.3", colnames(results)[31:58]) + 30] < 0.05) > 4),
# ]$name
# sig_list[[4]] <- results[
#   which(rowSums(results[ , grep("Fraction.4", colnames(results)[31:58]) + 30] < 0.05) > 2),
# ]$name
# sig_list[[5]] <- results[
#   which(rowSums(results[ , grep("Fraction.5", colnames(results)[31:58]) + 30] < 0.05) > 2),
# ]$name
# sig_list[[6]] <- results[
#   which(rowSums(results[ , grep("Fraction.6", colnames(results)[31:58]) + 30] < 0.05) > 3),
# ]$name
# sig_list[[7]] <- results[
#   which(rowSums(results[ , grep("Fraction.7", colnames(results)[31:58]) + 30] < 0.05) > 5),
# ]$name
# sig_list[[8]] <- results[
#   which(rowSums(results[ , grep("Fraction.8", colnames(results)[31:58]) + 30] < 0.05) > 5),
# ]$name

sig_list <- vector("list", 8)
sig_list[[1]] <- results[
  which(rowSums(results[ , grep("Fraction.1", colnames(results)[31:58]) + 30] < 0.05) > 0),
]$name
sig_list[[2]] <- results[
  which(rowSums(results[ , grep("Fraction.2", colnames(results)[31:58]) + 30] < 0.05) > 0),
]$name
sig_list[[3]] <- results[
  which(rowSums(results[ , grep("Fraction.3", colnames(results)[31:58]) + 30] < 0.05) > 3),
]$name
sig_list[[4]] <- results[
  which(rowSums(results[ , grep("Fraction.4", colnames(results)[31:58]) + 30] < 0.05) > 2),
]$name
sig_list[[5]] <- results[
  which(rowSums(results[ , grep("Fraction.5", colnames(results)[31:58]) + 30] < 0.05) > 2),
]$name
sig_list[[6]] <- results[
  which(rowSums(results[ , grep("Fraction.6", colnames(results)[31:58]) + 30] < 0.05) > 2),
]$name
sig_list[[7]] <- results[
  which(rowSums(results[ , grep("Fraction.7", colnames(results)[31:58]) + 30] < 0.05) > 5),
]$name
sig_list[[8]] <- results[
  which(rowSums(results[ , grep("Fraction.8", colnames(results)[31:58]) + 30] < 0.05) > 5),
]$name

keep <- vector()
for (i in seq_along(sig_list)) {
  for (j in seq_along(sig_list[[i]])) {
    results_sub <- results[results$name %in% sig_list[[i]][j], ]
    if (
      length(
        which(
          results_sub[ , grep(paste0("Fraction.", i), colnames(results_sub)[31:58]) + 30] < 0.05
        )
      ) == 1
    ) {
      sig_ratio <- results_sub[
        , sub(
          "p.adj", "ratio",
          colnames(
            results_sub[ , grep(paste0("Fraction.", i), colnames(results_sub)[31:58]) + 30] < 0.05
          )
        )
      ][ ,
         c(
           which(
             results_sub[ , grep(paste0("Fraction.", i), colnames(results_sub)[31:58]) + 30] < 0.05
            ),
           1
          )
      ]
      sig_ratio[ , 2] <- sig_ratio[ , 1]
    } else {
      sig_ratio <- results_sub[
        , sub(
          "p.adj", "ratio",
          colnames(
            results_sub[ , grep(paste0("Fraction.", i), colnames(results_sub)[31:58]) + 30] < 0.05
          )
        )
      ][ ,
         which(
           results_sub[ , grep(paste0("Fraction.", i), colnames(results_sub)[31:58]) + 30] < 0.05
          )
      ]
    }
    if (
      length(sig_ratio[ , grep(paste0("Fraction.", i, "_ratio"), colnames(sig_ratio))] < 0) == 1
    ) {
      if (sig_ratio[ , grep(paste0("Fraction.", i, "_ratio"), colnames(sig_ratio))] < 0) {
        direction <- 1
      } else (
        direction <- 0
      )
    } else {
      direction <- as.numeric(
        rowSums(sig_ratio[ , grep(paste0("Fraction.", i, "_ratio"), colnames(sig_ratio))] < 0)
      )
    }
    if (
      length(sig_ratio[ , grep(paste0("Fraction.", i, "_vs"), colnames(sig_ratio))] < 0) == 1
    ) {
      if (sig_ratio[ , grep(paste0("Fraction.", i, "_vs"), colnames(sig_ratio))] < 0) {
        direction <- direction + 1
      }
    } else {
    direction <- direction +
      as.numeric(
        rowSums(sig_ratio[ , grep(paste0("Fraction.", i, "_vs"), colnames(sig_ratio))] > 0)
      )
    }
    if (direction == ncol(sig_ratio)) {
      keep <- append(keep, results_sub$name)
    }
  }
  sig_list[[i]] <- sig_list[[i]][sig_list[[i]] %in% keep]
  keep <- vector()
}

for (i in seq_along(sig_list)) {
  
  if (length(sig_list[[i]]) > 1) {
    
    heatmap_data <- t(scale(t(assay(data)[rownames(data) %in% sig_list[[i]], ])))
    color2 <- colorRamp2(
      c(min(heatmap_data), (max(heatmap_data) + min(heatmap_data)) / 2, max(heatmap_data)),
      c(brewer.pal(3, "RdYlBu")[3], brewer.pal(3, "RdYlBu")[2], brewer.pal(3, "RdYlBu")[1])
    )

    draw(
      Heatmap(
        heatmap_data,
        color2,
        column_names_side = "top",
        cluster_columns = FALSE,
        row_dend_side = "right",
        column_split = data$donor,
        column_gap = unit(2, "mm"),
        heatmap_legend_param = list(
          title = "Scaled log2 Intensity", title_position = "leftcenter-rot"
        ),
        row_names_gp = gpar(fontsize = 6),
        column_names_gp = gpar(fontsize = 8),
        column_title = paste0("Fraction ", i)
      )
    )

    draw(
      Heatmap(
        heatmap_data,
        color2,
        column_names_side = "top",
        row_dend_side = "right",
        column_gap = unit(2, "mm"),
        heatmap_legend_param = list(
          title = "Scaled log2 Intensity", title_position = "leftcenter-rot"
        ),
        row_names_gp = gpar(fontsize = 6),
        column_names_gp = gpar(fontsize = 8),
        column_title = paste0("Fraction ", i)
      )
    )
  }
}
```

# Gene Set Enrichment

We perform gene set enrichment using methods available from the `GSVA` package [@hanzelmannGSVAGeneSet2013].

## Gene Ontology

```{r}
rds <- file.path(cache_dir, "filtered_GO_all_ENSG.rds")
if (file.exists(rds)) {
  gene_sets <- readRDS(rds)
} else {
  gene_sets <- getGmt(
    file.path(assets_dir, "gene-sets", "gprofiler_hsapiens.ENSG", "hsapiens.GO.all.ENSG.gmt")
  )
  keep <- filterGeneSets(gene_sets, 5, 50)
  gene_sets <- gene_sets[names(gene_sets) %in% names(keep)]
  for (i in seq(length(gene_sets@.Data))) {
    go_id <- gene_sets[[i]]@setName
    suppressWarnings(gene_sets[[i]]@setName <- gene_sets[[i]]@shortDescription)
    suppressWarnings(gene_sets[[i]]@shortDescription <- go_id)
  }
  remove <- grep("positive regulation of", names(gene_sets))
  if (length(remove) > 0) {
    gene_sets <- gene_sets[-remove]
  }
  remove <- grep("negative regulation of", names(gene_sets))
  if (length(remove) > 0) {
    gene_sets <- gene_sets[-remove]
  }
  remove <- grep("regulation of", names(gene_sets))
  if (length(remove) > 0) {
    gene_sets <- gene_sets[-remove]
  }
  remove <- grep("downregulation of", names(gene_sets))
  if (length(remove) > 0) {
    gene_sets <- gene_sets[-remove]
  }
  remove <- grep("inhibition of", names(gene_sets))
  if (length(remove) > 0) {
    gene_sets <- gene_sets[-remove]
  }
  remove <- grep("termination of", names(gene_sets))
  if (length(remove) > 0) {
    gene_sets <- gene_sets[-remove]
  }
  remove <- grep("activation of", names(gene_sets))
  if (length(remove) > 0) {
    gene_sets <- gene_sets[-remove]
  }
  remove <- grep("maintenance of", names(gene_sets))
  if (length(remove) > 0) {
    gene_sets <- gene_sets[-remove]
  }
  remove <- grep("upregulation of", names(gene_sets))
  if (length(remove) > 0) {
    gene_sets <- gene_sets[-remove]
  }
  saveRDS(gene_sets, rds)
}

rds <- file.path(cache_dir, "gene_anno.rds")
rds2 <- file.path(cache_dir, "new_mat.rds")
rds3 <- file.path(cache_dir, "gene_sets.rds")
if (file.exists(rds)) {
  gene_anno <- readRDS(rds)
  new_mat <- readRDS(rds2)
  gene_sets <- readRDS(rds3)
} else {
  mart <- useEnsembl("ensembl", "hsapiens_gene_ensembl")
  attributes <- c("external_gene_name", "ensembl_gene_id")
  gene_anno <- getBM(attributes, "external_gene_name", rownames(data), mart)
  gene_anno <- gene_anno[gene_anno$ensembl_gene_id %in% unique(unlist(geneIds(gene_sets))), ]

  tmp <- lapply(
    geneIds(gene_sets), function(x, y) na.omit(fastmatch::fmatch(x, y)), gene_anno$ensembl_gene_id
  )
  tmp <- filterGeneSets(tmp, 5, 50)
  gene_sets <- gene_sets[names(gene_sets) %in% names(tmp)]

  overlap <- computeGeneSetsOverlapMax(gene_sets, unique(unlist(geneIds(gene_sets))))
  tmp <- rowSums(overlap)
  tmp <- tmp[order(tmp, decreasing = TRUE)]
  gene_sets_sorted <- gene_sets[match(names(tmp), names(gene_sets))]

  overlap <- computeGeneSetsOverlapMax(gene_sets_sorted, unique(unlist(geneIds(gene_sets_sorted))))
  overlap[upper.tri(overlap)] <- 0
  diag(overlap) <- 0
  keep <- apply(overlap, 1, max)
  keep <- keep[keep < 1]
  gene_sets <- gene_sets[names(gene_sets) %in% names(keep)]

  gene_anno <- gene_anno[gene_anno$ensembl_gene_id %in% unique(unlist(geneIds(gene_sets))), ]

  dup <- gene_anno[duplicated(gene_anno$external_gene_name), ]
  if (nrow(dup) > 0) {
    for (i in 1:dim(dup)[1]) {
      for (j in 1:dim(gene_anno)[1]) {
        if (dup$ensembl_gene_id[i] == gene_anno$ensembl_gene_id[j]) {
          gene_anno$external_gene_name[j] <- paste0(gene_anno$external_gene_name[j], "-alt")
        }
      }
    }
    if (any(duplicated(gene_anno$external_gene_name))) {
      stop("Duplicates in gene_anno.")
    }
    new_mat <- data[rownames(data) %in% gene_anno$external_gene_name, ]
    new_mat <- assay(new_mat)
    for (i in 1:dim(dup)[1]) {
      for (j in 1:dim(data)[1]) {
        if (dup$external_gene_name[i] == rownames(data)[j]) {
          new_row <- assay(data[j, ])
          rownames(new_row) <- paste0(rownames(new_row), "-alt")
          if (rownames(new_row) %in% rownames(new_mat)) {
            rownames(new_row) <- paste0(rownames(new_row), "2")
          }
          new_mat <- rbind(new_mat, new_row)
        }
      }
    }
  } else {
    new_mat <- data[rownames(data) %in% gene_anno$external_gene_name, ]
    new_mat <- assay(new_mat)
  }
  gene_anno <- gene_anno[gene_anno$external_gene_name %in% rownames(new_mat), ]
  gene_anno <- gene_anno[order(match(gene_anno$external_gene_name, rownames(new_mat))), ]

  saveRDS(gene_anno, rds)
  saveRDS(new_mat, rds2)
  saveRDS(gene_sets, rds3)
}

rownames(new_mat) <- gene_anno$ensembl_gene_id
data_ENSG <- new_mat

rownames(new_mat) <- gene_anno$external_gene_name
data_name <- new_mat

rm(new_mat)

gsva <- gsva(data_ENSG, gene_sets, method = "ssgsea", ssgsea.norm = FALSE, verbose = FALSE)
datatable_download(gsva)

experimental_design$groups <- c(rep("F1_3", 24), rep("F4_6", 24), rep("F7_8", 16))
limma_design <- model.matrix(~ 0 + experimental_design$groups)
colnames(limma_design) <- unique(experimental_design$groups)
fit <- lmFit(gsva, limma_design)
contrast_mat <- makeContrasts(F1_3-F4_6, F1_3-F7_8, F4_6-F7_8, levels = limma_design)
cont_fit <- eBayes(contrasts.fit(fit, contrast_mat))
tests <- decideTests(cont_fit, "global")
write.fit(
  cont_fit, tests, adjust = "BH", method = "global", file = file.path(cache_dir, "results.tsv")
)
results <- read.delim(file.path(cache_dir, "results.tsv"))
rownames(results) <- results$X
results <- results[ , -1]
```

### F1-3

```{r, fig.width = 14}
tests_up <- tests[tests[ , 1] == 1 & tests[ , 2] == 1, ]

up <- results[rownames(results) %in% rownames(tests_up), ]
up$P.value.adj.F1_3...F4_6.P.value.adj.F1_3...F7_8 <-
  up$P.value.adj.F1_3...F4_6 + up$P.value.F1_3...F7_8
up <- up[order(up$P.value.adj.F1_3...F4_6.P.value.adj.F1_3...F7_8), ]

datatable_download_exp(up)

F1_3_curated <- up[
  rownames(up) %in% c(
    "G protein activity",
    "intrinsic component of synaptic vesicle membrane",
    "membrane raft assembly",
    "neuron cell-cell adhesion",
    "anchored component of external side of plasma membrane"
  ),
]

heatmap_data <- gsva[rownames(gsva) %in% rownames(up)[1:25], ]
colnames(heatmap_data) <- sub("\\.", " ", paste(data$condition, data$donor, sep = " "))
heatmap_data <- t(apply(heatmap_data, 1, function (x) ((2 * (x - min(x)) / (max(x) - min(x))) - 1)))
draw(
  Heatmap(
    heatmap_data,
    cluster_columns = FALSE,
    row_names_max_width = max_text_width(rownames(heatmap_data)),
    heatmap_legend_param = list(
      title = "Per-row Scaled ssGSEA Enrichment", direction = "horizontal",
      legend_width = unit(7.5, "cm")
    ),
    row_names_gp = gpar(fontsize = 10),
    column_names_gp = gpar(fontsize = 10)
  ),
  heatmap_legend_side = "top"
)
```

### F4-6

```{r, fig.width = 14}
tests_up <- tests[tests[ , 1] == -1 & tests[ , 3] == 1, ]

up <- results[rownames(results) %in% rownames(tests_up), ]
up$P.value.adj.F1_3...F4_6.P.value.adj.F4_6...F7_8 <-
  up$P.value.adj.F1_3...F4_6 + up$P.value.adj.F4_6...F7_8
up <- up[order(up$P.value.adj.F1_3...F4_6.P.value.adj.F4_6...F7_8), ]

datatable_download_exp(up)

F4_6_curated <- up[
  rownames(up) %in% c(
    "exocyst",
    "vesicle-mediated transport between endosomal compartments",
    "early phagosome",
    "early endosome to late endosome transport",
    "retromer complex",
    "protein folding chaperone",
    "tau protein binding",
    "phagosome maturation",
    "late endosome to vacuole transport via multivesicular body sorting pathway",
    "late endosome to lysosome transport",
    "neuronal dense core vesicle",
    "exosomal secretion",
    "TRAPP complex"
  ),
]

heatmap_data <- gsva[rownames(gsva) %in% rownames(up)[1:25], ]
colnames(heatmap_data) <- sub("\\.", " ", paste(data$condition, data$donor, sep = " "))
heatmap_data <- t(apply(heatmap_data, 1, function (x) ((2 * (x - min(x)) / (max(x) - min(x))) - 1)))
draw(
  Heatmap(
    heatmap_data,
    cluster_columns = FALSE,
    row_names_max_width = max_text_width(rownames(heatmap_data)),
    heatmap_legend_param = list(
      title = "Per-row Scaled ssGSEA Enrichment", direction = "horizontal",
      legend_width = unit(7.5, "cm")
    ),
    row_names_gp = gpar(fontsize = 10),
    column_names_gp = gpar(fontsize = 10)
  ),
  heatmap_legend_side = "top"
)
```

### F7-8

```{r, fig.width = 14}
tests_up <- tests[tests[ , 2] == -1 & tests[ , 3] == -1, ]

up <- results[rownames(results) %in% rownames(tests_up), ]
up$P.value.adj.F1_3...F7_8.P.value.adj.F4_6...F7_8 <-
  up$P.value.adj.F1_3...F7_8 + up$P.value.adj.F4_6...F7_8
up <- up[order(up$P.value.adj.F1_3...F7_8.P.value.adj.F4_6...F7_8), ]

datatable_download_exp(up)

F7_8_curated <- up[
  rownames(up) %in% c(
    "proton motive force-driven mitochondrial ATP synthesis",
    "outer mitochondrial membrane protein complex",
    "peroxisome organization",
    "peroxisome fission",
    "Hrd1p ubiquitin ligase ERAD-L complex",
    "ER ubiquitin ligase complex"
  ),
]

heatmap_data <- gsva[rownames(gsva) %in% rownames(up)[1:25], ]
colnames(heatmap_data) <- sub("\\.", " ", paste(data$condition, data$donor, sep = " "))
heatmap_data <- t(apply(heatmap_data, 1, function (x) ((2 * (x - min(x)) / (max(x) - min(x))) - 1)))
draw(
  Heatmap(
    heatmap_data,
    cluster_columns = FALSE,
    row_names_max_width = max_text_width(rownames(heatmap_data)),
    heatmap_legend_param = list(
      title = "Per-row Scaled ssGSEA Enrichment", direction = "horizontal",
      legend_width = unit(7.5, "cm")
    ),
    row_names_gp = gpar(fontsize = 10),
    column_names_gp = gpar(fontsize = 10)
  ),
  heatmap_legend_side = "top"
)
```

### Curated

```{r, fig.width = 14}
order <- c(rownames(F1_3_curated), rownames(F4_6_curated), rownames(F7_8_curated))
heatmap_data <- gsva[rownames(gsva) %in% order, ]
heatmap_data <- heatmap_data[match(order, rownames(heatmap_data)), ]
colnames(heatmap_data) <- sub("\\.", " ", paste(data$condition, data$donor, sep = " "))
heatmap_data <- t(apply(heatmap_data, 1, function (x) ((2 * (x - min(x)) / (max(x) - min(x))) - 1)))
draw(
  Heatmap(
    heatmap_data,
    cluster_columns = FALSE,
    cluster_rows = FALSE,
    row_names_max_width = max_text_width(rownames(heatmap_data)),
    heatmap_legend_param = list(
      title = "Per-row Scaled ssGSEA Enrichment", direction = "horizontal",
      legend_width = unit(7.5, "cm")
    ),
    row_names_gp = gpar(fontsize = 10),
    column_names_gp = gpar(fontsize = 10)
  ),
  heatmap_legend_side = "top"
)
```

# References

This is the concluding section of the document, where we output the `sessionInfo`, and create a bibliography for works cited.

```{r}
sessionInfo()
```
