---
title: "Combined AD CTRL"
author:
  - name: "Emir, Pal, and Steph"
date: '`r strftime(Sys.time(), "%B %d, %Y")`'
bibliography: "../AD-CBD-exosome-proteins.bib"
link-citations: true
output:
  html_document:
    code_folding: hide
    number_sections: true
    theme: lumen
    highlight: haddock
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: false
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(
    "..", "results", "combined-AD-CTRL.html"
  ))})
---

<style type="text/css">
body {font-size: 16px;}
h1.title {font-size: 35px;}
h1 {font-size: 24px;}
h2 {font-size: 22px;}
h3 {font-size: 20px;}
.toc-content {padding-left: 0px; padding-right: 0px;}
div.tocify {width: 100%;}
.tocify-subheader .tocify-item {font-size: 0.95em; padding-left: 25px; text-indent: 0;}
.tocify-subheader .tocify-subheader .tocify-item {
  font-size: 0.95em; padding-left: 35px; text-indent: 0;
}
div.main-container {max-width: none; width: 100%;}
</style>

*This file is a part of [AD-CBD-exosome-proteins](https://github.com/eturkes/AD-CBD-exosome-proteins).*
*Please email me for access.*

The data here is derived from @combined and will be referenced using the name `combined`.

```{r}
# Copyright 2019-2020 Emir Turkes, Stephanie Fowler, Guar Pallavi, UK DRI at UCL,
# Columbia University Medical Center
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
#     http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# This section should be checked per document.
# --------------------------------------------
options(stringsAsFactors = FALSE)
packages <- c(
  "RColorBrewer", "dplyr", "DEP", "SummarizedExperiment", "ggplot2", "DT", "ComplexHeatmap"
)
invisible(suppressPackageStartupMessages(lapply(packages, library, character.only = TRUE)))
source(file.path(getwd(), "utils.R"))

data_name <- "combined"
color <- colorRampPalette(rev(brewer.pal(7, "RdBu")))(100)
color_legend <- c("lightgray", "darkgray")
`%notin%` <- Negate(`%in%`)
# --------------------------------------------

# Everything else in this chunk remains generally unchanged.
# ----------------------------------------------------------
assets_dir <- file.path(getwd(), "..", "assets") # Backed up data.

cache_dir <- file.path(getwd(), "..", "tmp", "cache")
if (!dir.exists(cache_dir)) {
  dir.create(cache_dir, recursive = TRUE)
}

knitr::opts_chunk$set(fig.width = 10, fig.height = 7)
```

# All Data (MAR Imputation = MLE)

## Prep

```{r}
data <- read.csv(file.path(assets_dir, data_name, "data_comb_steph.csv"), row.names = "Gene.names_")
design <- read.csv(file.path(assets_dir, data_name, "comb_steph_newexp_design.csv"))

data <- make_unique(data, "Gene.names", "Protein.IDs.x", ";")
LFQ_columns <- grep("Intensity.", colnames(data))

data <- make_se(data, LFQ_columns, design)
# colnames(data) <- gsub("^.*?_", "", colnames(data)) # Remove redundant labels. # TODO: Fix this.
data
```

**Unaltered data, already log2 transformed.**

```{r}
datatable_download(assay(data))
```

**After removal of log transformation.**

```{r}
datatable_download(2 ^ assay(data))
```

## QC

### Histogram

```{r}
hist(assay(data), n = 100)
```

### Missing Value Removal

```{r}
# assay(data) <- 2 ^ assay(data) # Undo log transformation.

discard <- which(
  is.na(rowMeans(assay(data)[ , 1:ceiling(ncol(data) / 2)], na.rm = TRUE))
)
data <- data[-discard, ]
discard <- which(
  is.na(rowMeans(assay(data)[ , (ceiling(ncol(data) / 2) + 1):ncol(data)], na.rm = TRUE))
)
data <- data[-discard, ]

data <- data[order(rowMeans(assay(data), na.rm = TRUE)), ]

plot_numbers(data)
plot_frequency(data)
plot_detect(data)
```

```{r, fig.height = 30}
plot_missval_custom(data)

complete_cases <- filter_proteins(data, "complete")

missing_data <- assay(data) %>% data.frame(.)
missing_data <- ifelse(is.na(missing_data), 0, 1)
discard <- which(
  rowSums(
    missing_data[ , 1:ceiling(ncol(missing_data) / 2)], na.rm = TRUE
  ) <= 4
)
data <- data[-discard, ]
print(paste0("Removed ", length(discard), " proteins from AD group."))

missing_data <- assay(data) %>% data.frame(.)
missing_data <- ifelse(is.na(missing_data), 0, 1)
discard <- which(
  rowSums(
    missing_data[ , (ceiling(ncol(missing_data) / 2) + 1):ncol(missing_data)], na.rm = TRUE
  ) <= 4
)
data <- data[-discard, ]
print(paste0("Removed ", length(discard), " proteins from Control group."))

data <- data[sort(rownames(data)), ]
AD_order <- order(
  rowMeans(assay(data)[ , 1:ceiling(ncol(data) / 2)], na.rm = TRUE)
)
data <- data[AD_order, ]
AD_MNAR <- rownames(data)[1:which(rownames(data) == "SLC12A2")]
plot_missval_custom(data)

data <- data[sort(rownames(data)), ]
Control_order <- order(
  rowMeans(assay(data)[ , (ceiling(ncol(data) / 2) + 1):ncol(data)], na.rm = TRUE)
)
data <- data[Control_order, ]
Control_MNAR <- rownames(data)[1:which(rownames(data) == "FRRS1L")]
plot_missval_custom(data)
```

```{r}
missing_data <- assay(data) %>% data.frame(.)
missing_data <- missing_data[apply(missing_data, 1, function(x) any(is.na(x))), ]

plot_numbers(data)
plot_frequency(data)
plot_detect(data)
```

**Data before normalization but after removal of missing values.**

```{r}
datatable_download(assay(data))
```

**Complete cases before normalization but after removal of missing values.**

```{r}
datatable_download(assay(complete_cases))
```

### Normalization

```{r}
VSN_Normalized <- normalize_vsn(data)
Log_Transform_Only <- data

VSN_Normalized_Non_Missing_Data <- normalize_vsn(complete_cases)
Log_Transform_Only_Non_Missing_Data <- complete_cases

print("Log_Transform_Only")
meanSdPlot(Log_Transform_Only)
print("Log_Transform_Only_Non_Missing_Data")
meanSdPlot(Log_Transform_Only_Non_Missing_Data)
print("VSN_Normalized")
meanSdPlot(VSN_Normalized)
print("VSN_Normalized_Non_Missing_Data")
meanSdPlot(VSN_Normalized_Non_Missing_Data)

plot_normalization(Log_Transform_Only, VSN_Normalized)
plot_normalization(Log_Transform_Only_Non_Missing_Data, VSN_Normalized_Non_Missing_Data)

data <- VSN_Normalized
complete_cases <- VSN_Normalized_Non_Missing_Data
rm(
  VSN_Normalized, VSN_Normalized_Non_Missing_Data,
  Log_Transform_Only, Log_Transform_Only_Non_Missing_Data
)
```

```{r, fig.height = 30}
data <- data[sort(rownames(data)), ]
data <- data[AD_order, ]
plot_missval_custom(data)

data <- data[sort(rownames(data)), ]
data <- data[Control_order, ]
plot_missval_custom(data)
```

**Data after normalization and log2 transformation.**

```{r}
datatable_download(assay(data))
```

### Missing Value Imputation

```{r}
Unimputed_Data <- data
Non_Missing_data <- complete_cases
plot_imputation(Unimputed_Data, Non_Missing_data)
rm(Non_Missing_data)

impute1 <- data[ , 1:ceiling(ncol(data) / 2)]
impute_vector <- rownames(impute1) %in% AD_MNAR
set.seed(1)
impute1 <- impute(impute1, "mixed", randna = !impute_vector, mar = "MLE", mnar = "MinDet")

impute2 <- data[ , (ceiling(ncol(data) / 2) + 1):ncol(data)]
impute_vector <- rownames(impute2) %in% Control_MNAR
set.seed(1)
impute2 <- impute(impute2, "mixed", randna = !impute_vector, mar = "MLE", mnar = "MinDet")

Imputed_Data <- data
assay(Imputed_Data) <- cbind(assay(impute1), assay(impute2))

plot_imputation(Imputed_Data)

data <- Imputed_Data
rm(impute1, impute2)
```

```{r, fig.height = 30}
data <- data[sort(rownames(data)), ]
data <- data[AD_order, ]
heatmap_data <- data[rownames(data) %in% rownames(missing_data), ]
Heatmap(
  assay(heatmap_data),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(heatmap_data)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  cluster_rows = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)

data <- data[sort(rownames(data)), ]
data <- data[Control_order, ]
heatmap_data <- data[rownames(data) %in% rownames(missing_data), ]
Heatmap(
  assay(heatmap_data),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(heatmap_data)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  cluster_rows = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)
```

```{r}
plot_normalization(Unimputed_Data, Imputed_Data)
print("Unimputed Data")
meanSdPlot(Unimputed_Data)
print("Imputed Data")
meanSdPlot(Imputed_Data)

rm(Imputed_Data, heatmap_data)
```

**Data after missing value imputation.**
**This is final form used for differential expression analysis**

```{r}
datatable_download(assay(data))
```

### PCA

```{r}
plot_pca(data, indicate = c("condition", "label"), label = TRUE) +
  scale_shape_manual(values = seq(0, ncol(data)))
```

## Differential Expression

The results below are filtered for significance ($adjP < 0.05$).

```{r}
hvp <- apply(assay(data), 1, sd)
hvp <- hvp[order(hvp, decreasing = TRUE)]
hvp <- hvp[1:500]
hvp <- data[rownames(data) %in% names(hvp), ]

hvp <- add_rejections(test_diff(hvp, "control", "Control"), lfc = 0)
data_results <- get_results(hvp)
sig <- data_results[data_results$significant, ]
print(paste0(nrow(sig), " significant proteins."))

no_mult_testing <- data_results[data_results$AD_vs_Control_p.val < 0.05, ]
no_mult_testing <- hvp[rownames(hvp) %in% no_mult_testing$name, ]
datatable_download(data_results)
```

```{r, fig.height = 30}
Heatmap(
  assay(data),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(data)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)

Heatmap(
  assay(hvp),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(hvp)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)

Heatmap(
  assay(no_mult_testing),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(no_mult_testing)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)

missing_no_mult_testing <- no_mult_testing[rownames(no_mult_testing) %in% rownames(missing_data), ]
heatmap <- Heatmap(
  assay(missing_no_mult_testing),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(missing_no_mult_testing)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)
draw(heatmap)

unimputed_missing_no_mult_testing <- Unimputed_Data[
  rownames(Unimputed_Data) %in% rownames(missing_no_mult_testing),
]
Heatmap(
  assay(unimputed_missing_no_mult_testing),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(missing_no_mult_testing)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_order = row_order(heatmap),
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)
```

## Non-Missing Data

### PCA

```{r}
plot_pca(
  complete_cases, n = dim(complete_cases)[1], indicate = c("condition", "label"), label = TRUE
  ) + scale_shape_manual(values = seq(0, ncol(data)))
```

### Differential Expression

```{r}
complete_cases <- add_rejections(test_diff(complete_cases, "control", "Control"), lfc = 0)
data_results <- get_results(complete_cases)
sig <- data_results[data_results$significant, ]
print(paste0(nrow(sig), " significant proteins."))

no_mult_testing <- data_results[data_results$AD_vs_Control_p.val < 0.05, ]
no_mult_testing <- complete_cases[rownames(complete_cases) %in% no_mult_testing$name, ]
with_mult_testing <- data_results[data_results$AD_vs_Control_p.adj < 0.05, ]
with_mult_testing <- complete_cases[rownames(complete_cases) %in% with_mult_testing$name, ]
datatable_download(data_results)

plot_heatmap(complete_cases, "centered", TRUE, round((nrow(sig) - 1) / 2), row_font_size = 9)
plot_cor(complete_cases, pal = "RdBu", pal_rev = TRUE)
plot_volcano(complete_cases, "AD_vs_Control", label_size = 4, adjusted = TRUE)

plot_single(complete_cases, sig$name, "centered") + xlab(element_blank())
```

```{r}
Heatmap(
  assay(complete_cases),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(complete_cases)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)

Heatmap(
  assay(no_mult_testing),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(no_mult_testing)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)

Heatmap(
  assay(with_mult_testing),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(with_mult_testing)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)
```

# All Data (MAR Imputation = KNN)

## Prep

```{r}
data <- read.csv(file.path(assets_dir, data_name, "data_comb_steph.csv"), row.names = "Gene.names_")
design <- read.csv(file.path(assets_dir, data_name, "comb_steph_newexp_design.csv"))

data <- make_unique(data, "Gene.names", "Protein.IDs.x", ";")
LFQ_columns <- grep("Intensity.", colnames(data))

data <- make_se(data, LFQ_columns, design)
# colnames(data) <- gsub("^.*?_", "", colnames(data)) # Remove redundant labels. # TODO: Fix this.
data
```

**Unaltered data, already log2 transformed.**

```{r}
datatable_download(assay(data))
```

**After removal of log transformation.**

```{r}
datatable_download(2 ^ assay(data))
```

## QC

### Histogram

```{r}
hist(assay(data), n = 100)
```

### Missing Value Removal

```{r}
# assay(data) <- 2 ^ assay(data) # Undo log transformation.

discard <- which(
  is.na(rowMeans(assay(data)[ , 1:ceiling(ncol(data) / 2)], na.rm = TRUE))
)
data <- data[-discard, ]
discard <- which(
  is.na(rowMeans(assay(data)[ , (ceiling(ncol(data) / 2) + 1):ncol(data)], na.rm = TRUE))
)
data <- data[-discard, ]

data <- data[order(rowMeans(assay(data), na.rm = TRUE)), ]

plot_numbers(data)
plot_frequency(data)
plot_detect(data)
```

```{r, fig.height = 30}
plot_missval_custom(data)

complete_cases <- filter_proteins(data, "complete")

missing_data <- assay(data) %>% data.frame(.)
missing_data <- ifelse(is.na(missing_data), 0, 1)
discard <- which(
  rowSums(
    missing_data[ , 1:ceiling(ncol(missing_data) / 2)], na.rm = TRUE
  ) <= 4
)
data <- data[-discard, ]
print(paste0("Removed ", length(discard), " proteins from AD group."))

missing_data <- assay(data) %>% data.frame(.)
missing_data <- ifelse(is.na(missing_data), 0, 1)
discard <- which(
  rowSums(
    missing_data[ , (ceiling(ncol(missing_data) / 2) + 1):ncol(missing_data)], na.rm = TRUE
  ) <= 4
)
data <- data[-discard, ]
print(paste0("Removed ", length(discard), " proteins from Control group."))

data <- data[sort(rownames(data)), ]
AD_order <- order(
  rowMeans(assay(data)[ , 1:ceiling(ncol(data) / 2)], na.rm = TRUE)
)
data <- data[AD_order, ]
AD_MNAR <- rownames(data)[1:which(rownames(data) == "SLC12A2")]
plot_missval_custom(data)

data <- data[sort(rownames(data)), ]
Control_order <- order(
  rowMeans(assay(data)[ , (ceiling(ncol(data) / 2) + 1):ncol(data)], na.rm = TRUE)
)
data <- data[Control_order, ]
Control_MNAR <- rownames(data)[1:which(rownames(data) == "FRRS1L")]
plot_missval_custom(data)
```

```{r}
missing_data <- assay(data) %>% data.frame(.)
missing_data <- missing_data[apply(missing_data, 1, function(x) any(is.na(x))), ]

plot_numbers(data)
plot_frequency(data)
plot_detect(data)
```

**Data before normalization but after removal of missing values.**

```{r}
datatable_download(assay(data))
```

**Complete cases before normalization but after removal of missing values.**

```{r}
datatable_download(assay(complete_cases))
```

### Normalization

```{r}
VSN_Normalized <- normalize_vsn(data)
Log_Transform_Only <- data

VSN_Normalized_Non_Missing_Data <- normalize_vsn(complete_cases)
Log_Transform_Only_Non_Missing_Data <- complete_cases

print("Log_Transform_Only")
meanSdPlot(Log_Transform_Only)
print("Log_Transform_Only_Non_Missing_Data")
meanSdPlot(Log_Transform_Only_Non_Missing_Data)
print("VSN_Normalized")
meanSdPlot(VSN_Normalized)
print("VSN_Normalized_Non_Missing_Data")
meanSdPlot(VSN_Normalized_Non_Missing_Data)

plot_normalization(Log_Transform_Only, VSN_Normalized)
plot_normalization(Log_Transform_Only_Non_Missing_Data, VSN_Normalized_Non_Missing_Data)

data <- VSN_Normalized
complete_cases <- VSN_Normalized_Non_Missing_Data
rm(
  VSN_Normalized, VSN_Normalized_Non_Missing_Data,
  Log_Transform_Only, Log_Transform_Only_Non_Missing_Data
)
```

```{r, fig.height = 30}
data <- data[sort(rownames(data)), ]
data <- data[AD_order, ]
plot_missval_custom(data)

data <- data[sort(rownames(data)), ]
data <- data[Control_order, ]
plot_missval_custom(data)
```

**Data after normalization and log2 transformation.**

```{r}
datatable_download(assay(data))
```

### Missing Value Imputation

```{r}
Unimputed_Data <- data
Non_Missing_data <- complete_cases
plot_imputation(Unimputed_Data, Non_Missing_data)
rm(Non_Missing_data)

impute1 <- data[ , 1:ceiling(ncol(data) / 2)]
impute_vector <- rownames(impute1) %in% AD_MNAR
set.seed(1)
impute1 <- impute(impute1, "mixed", randna = !impute_vector, mar = "knn", mnar = "MinDet")

impute2 <- data[ , (ceiling(ncol(data) / 2) + 1):ncol(data)]
impute_vector <- rownames(impute2) %in% Control_MNAR
set.seed(1)
impute2 <- impute(impute2, "mixed", randna = !impute_vector, mar = "knn", mnar = "MinDet")

Imputed_Data <- data
assay(Imputed_Data) <- cbind(assay(impute1), assay(impute2))

plot_imputation(Imputed_Data)

data <- Imputed_Data
rm(impute1, impute2)
```

```{r, fig.height = 30}
data <- data[sort(rownames(data)), ]
data <- data[AD_order, ]
heatmap_data <- data[rownames(data) %in% rownames(missing_data), ]
Heatmap(
  assay(heatmap_data),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(heatmap_data)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  cluster_rows = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)

data <- data[sort(rownames(data)), ]
data <- data[Control_order, ]
heatmap_data <- data[rownames(data) %in% rownames(missing_data), ]
Heatmap(
  assay(heatmap_data),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(heatmap_data)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  cluster_rows = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)
```

```{r}
plot_normalization(Unimputed_Data, Imputed_Data)
print("Unimputed Data")
meanSdPlot(Unimputed_Data)
print("Imputed Data")
meanSdPlot(Imputed_Data)

rm(Imputed_Data, heatmap_data)
```

**Data after missing value imputation.**
**This is final form used for differential expression analysis**

```{r}
datatable_download(assay(data))
```

### PCA

```{r}
plot_pca(data, indicate = c("condition", "label"), label = TRUE) +
  scale_shape_manual(values = seq(0, ncol(data)))
```

## Differential Expression

The results below are filtered for significance ($adjP < 0.05$).

```{r}
hvp <- apply(assay(data), 1, sd)
hvp <- hvp[order(hvp, decreasing = TRUE)]
hvp <- hvp[1:500]
hvp <- data[rownames(data) %in% names(hvp), ]

hvp <- add_rejections(test_diff(hvp, "control", "Control"), lfc = 0)
data_results <- get_results(hvp)
sig <- data_results[data_results$significant, ]
print(paste0(nrow(sig), " significant proteins."))

no_mult_testing <- data_results[data_results$AD_vs_Control_p.val < 0.05, ]
no_mult_testing <- hvp[rownames(hvp) %in% no_mult_testing$name, ]
datatable_download(data_results)
```

```{r, fig.height = 30}
Heatmap(
  assay(data),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(data)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)

Heatmap(
  assay(hvp),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(hvp)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)

Heatmap(
  assay(no_mult_testing),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(no_mult_testing)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)

missing_no_mult_testing <- no_mult_testing[rownames(no_mult_testing) %in% rownames(missing_data), ]
heatmap <- Heatmap(
  assay(missing_no_mult_testing),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(missing_no_mult_testing)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)
draw(heatmap)

unimputed_missing_no_mult_testing <- Unimputed_Data[
  rownames(Unimputed_Data) %in% rownames(missing_no_mult_testing),
]
Heatmap(
  assay(unimputed_missing_no_mult_testing),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(missing_no_mult_testing)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_order = row_order(heatmap),
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)
```

## Non-Missing Data

### PCA

```{r}
plot_pca(
  complete_cases, n = dim(complete_cases)[1], indicate = c("condition", "label"), label = TRUE
  ) + scale_shape_manual(values = seq(0, ncol(data)))
```

### Differential Expression

```{r}
complete_cases <- add_rejections(test_diff(complete_cases, "control", "Control"), lfc = 0)
data_results <- get_results(complete_cases)
sig <- data_results[data_results$significant, ]
print(paste0(nrow(sig), " significant proteins."))

no_mult_testing <- data_results[data_results$AD_vs_Control_p.val < 0.05, ]
no_mult_testing <- complete_cases[rownames(complete_cases) %in% no_mult_testing$name, ]
with_mult_testing <- data_results[data_results$AD_vs_Control_p.adj < 0.05, ]
with_mult_testing <- complete_cases[rownames(complete_cases) %in% with_mult_testing$name, ]
datatable_download(data_results)

plot_heatmap(complete_cases, "centered", TRUE, round((nrow(sig) - 1) / 2), row_font_size = 9)
plot_cor(complete_cases, pal = "RdBu", pal_rev = TRUE)
plot_volcano(complete_cases, "AD_vs_Control", label_size = 4, adjusted = TRUE)

plot_single(complete_cases, sig$name, "centered") + xlab(element_blank())
```

```{r}
Heatmap(
  assay(complete_cases),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(complete_cases)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)

Heatmap(
  assay(no_mult_testing),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(no_mult_testing)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)

Heatmap(
  assay(with_mult_testing),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(with_mult_testing)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)
```

# AD2 Removal (MAR Imputation = MLE)

## Prep

```{r}
data <- read.csv(file.path(assets_dir, data_name, "data_comb_steph.csv"), row.names = "Gene.names_")
design <- read.csv(file.path(assets_dir, data_name, "comb_steph_newexp_design.csv"))

data[ , grep("AD_5365", colnames(data))] <- NULL
design <- design[-which(design$label == "AD_5365"), ]

data <- make_unique(data, "Gene.names", "Protein.IDs.x", ";")
LFQ_columns <- grep("Intensity.", colnames(data))

data <- make_se(data, LFQ_columns, design)
# colnames(data) <- gsub("^.*?_", "", colnames(data)) # Remove redundant labels. # TODO: Fix this.
data
```

**Unaltered data, already log2 transformed.**

```{r}
datatable_download(assay(data))
```

**After removal of log transformation.**

```{r}
datatable_download(2 ^ assay(data))
```

## QC

### Histogram

```{r}
hist(assay(data), n = 100)
```

### Missing Value Removal

```{r}
# assay(data) <- 2 ^ assay(data) # Undo log transformation.

discard <- which(
  is.na(rowMeans(assay(data)[ , 1:ceiling(ncol(data) / 2)], na.rm = TRUE))
)
data <- data[-discard, ]
discard <- which(
  is.na(rowMeans(assay(data)[ , (ceiling(ncol(data) / 2) + 1):ncol(data)], na.rm = TRUE))
)
data <- data[-discard, ]

data <- data[order(rowMeans(assay(data), na.rm = TRUE)), ]

plot_numbers(data)
plot_frequency(data)
plot_detect(data)
```

```{r, fig.height = 30}
plot_missval_custom(data)

complete_cases <- filter_proteins(data, "complete")

missing_data <- assay(data) %>% data.frame(.)
missing_data <- ifelse(is.na(missing_data), 0, 1)
discard <- which(
  rowSums(
    missing_data[ , 1:ceiling(ncol(missing_data) / 2)], na.rm = TRUE
  ) <= 4
)
data <- data[-discard, ]
print(paste0("Removed ", length(discard), " proteins from AD group."))

missing_data <- assay(data) %>% data.frame(.)
missing_data <- ifelse(is.na(missing_data), 0, 1)
discard <- which(
  rowSums(
    missing_data[ , (ceiling(ncol(missing_data) / 2) + 1):ncol(missing_data)], na.rm = TRUE
  ) <= 4
)
data <- data[-discard, ]
print(paste0("Removed ", length(discard), " proteins from Control group."))

data <- data[sort(rownames(data)), ]
AD_order <- order(
  rowMeans(assay(data)[ , 1:ceiling(ncol(data) / 2)], na.rm = TRUE)
)
data <- data[AD_order, ]
AD_MNAR <- rownames(data)[1:which(rownames(data) == "IMPA1")]
plot_missval_custom(data)

data <- data[sort(rownames(data)), ]
Control_order <- order(
  rowMeans(assay(data)[ , (ceiling(ncol(data) / 2) + 1):ncol(data)], na.rm = TRUE)
)
data <- data[Control_order, ]
Control_MNAR <- rownames(data)[1:which(rownames(data) == "FRRS1L")]
plot_missval_custom(data)
```

```{r}
missing_data <- assay(data) %>% data.frame(.)
missing_data <- missing_data[apply(missing_data, 1, function(x) any(is.na(x))), ]

plot_numbers(data)
plot_frequency(data)
plot_detect(data)
```

**Data before normalization but after removal of missing values.**

```{r}
datatable_download(assay(data))
```

**Complete cases before normalization but after removal of missing values.**

```{r}
datatable_download(assay(complete_cases))
```

### Normalization

```{r}
VSN_Normalized <- normalize_vsn(data)
Log_Transform_Only <- data

VSN_Normalized_Non_Missing_Data <- normalize_vsn(complete_cases)
Log_Transform_Only_Non_Missing_Data <- complete_cases

print("Log_Transform_Only")
meanSdPlot(Log_Transform_Only)
print("Log_Transform_Only_Non_Missing_Data")
meanSdPlot(Log_Transform_Only_Non_Missing_Data)
print("VSN_Normalized")
meanSdPlot(VSN_Normalized)
print("VSN_Normalized_Non_Missing_Data")
meanSdPlot(VSN_Normalized_Non_Missing_Data)

plot_normalization(Log_Transform_Only, VSN_Normalized)
plot_normalization(Log_Transform_Only_Non_Missing_Data, VSN_Normalized_Non_Missing_Data)

data <- VSN_Normalized
complete_cases <- VSN_Normalized_Non_Missing_Data
rm(
  VSN_Normalized, VSN_Normalized_Non_Missing_Data,
  Log_Transform_Only, Log_Transform_Only_Non_Missing_Data
)
```

```{r, fig.height = 30}
data <- data[sort(rownames(data)), ]
data <- data[AD_order, ]
plot_missval_custom(data)

data <- data[sort(rownames(data)), ]
data <- data[Control_order, ]
plot_missval_custom(data)
```

**Data after normalization and log2 transformation.**

```{r}
datatable_download(assay(data))
```

### Missing Value Imputation

```{r}
Unimputed_Data <- data
Non_Missing_data <- complete_cases
plot_imputation(Unimputed_Data, Non_Missing_data)
rm(Non_Missing_data)

impute1 <- data[ , 1:ceiling(ncol(data) / 2)]
impute_vector <- rownames(impute1) %in% AD_MNAR
set.seed(1)
impute1 <- impute(impute1, "mixed", randna = !impute_vector, mar = "MLE", mnar = "MinDet")

impute2 <- data[ , (ceiling(ncol(data) / 2) + 1):ncol(data)]
impute_vector <- rownames(impute2) %in% Control_MNAR
set.seed(1)
impute2 <- impute(impute2, "mixed", randna = !impute_vector, mar = "MLE", mnar = "MinDet")

Imputed_Data <- data
assay(Imputed_Data) <- cbind(assay(impute1), assay(impute2))

plot_imputation(Imputed_Data)

data <- Imputed_Data
rm(impute1, impute2)
```

```{r, fig.height = 30}
data <- data[sort(rownames(data)), ]
data <- data[AD_order, ]
heatmap_data <- data[rownames(data) %in% rownames(missing_data), ]
Heatmap(
  assay(heatmap_data),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(heatmap_data)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  cluster_rows = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)

data <- data[sort(rownames(data)), ]
data <- data[Control_order, ]
heatmap_data <- data[rownames(data) %in% rownames(missing_data), ]
Heatmap(
  assay(heatmap_data),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(heatmap_data)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  cluster_rows = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)
```

```{r}
plot_normalization(Unimputed_Data, Imputed_Data)
print("Unimputed Data")
meanSdPlot(Unimputed_Data)
print("Imputed Data")
meanSdPlot(Imputed_Data)

rm(Imputed_Data, heatmap_data)
```

**Data after missing value imputation.**
**This is final form used for differential expression analysis**

```{r}
datatable_download(assay(data))
```

### PCA

```{r}
plot_pca(data, indicate = c("condition", "label"), label = TRUE) +
  scale_shape_manual(values = seq(0, ncol(data)))
```

## Differential Expression

The results below are filtered for significance ($adjP < 0.05$).

```{r}
hvp <- apply(assay(data), 1, sd)
hvp <- hvp[order(hvp, decreasing = TRUE)]
hvp <- hvp[1:500]
hvp <- data[rownames(data) %in% names(hvp), ]

hvp <- add_rejections(test_diff(hvp, "control", "Control"), lfc = 0)
data_results <- get_results(hvp)
sig <- data_results[data_results$significant, ]
print(paste0(nrow(sig), " significant proteins."))

no_mult_testing <- data_results[data_results$AD_vs_Control_p.val < 0.05, ]
no_mult_testing <- hvp[rownames(hvp) %in% no_mult_testing$name, ]
datatable_download(data_results)
```

```{r, fig.height = 30}
Heatmap(
  assay(data),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(data)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)

Heatmap(
  assay(hvp),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(hvp)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)

Heatmap(
  assay(no_mult_testing),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(no_mult_testing)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)

missing_no_mult_testing <- no_mult_testing[rownames(no_mult_testing) %in% rownames(missing_data), ]
heatmap <- Heatmap(
  assay(missing_no_mult_testing),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(missing_no_mult_testing)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)
draw(heatmap)

unimputed_missing_no_mult_testing <- Unimputed_Data[
  rownames(Unimputed_Data) %in% rownames(missing_no_mult_testing),
]
Heatmap(
  assay(unimputed_missing_no_mult_testing),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(missing_no_mult_testing)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_order = row_order(heatmap),
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)
```

## Non-Missing Data

### PCA

```{r}
plot_pca(
  complete_cases, n = dim(complete_cases)[1], indicate = c("condition", "label"), label = TRUE
  ) + scale_shape_manual(values = seq(0, ncol(data)))
```

### Differential Expression

```{r}
complete_cases <- add_rejections(test_diff(complete_cases, "control", "Control"), lfc = 0)
data_results <- get_results(complete_cases)
sig <- data_results[data_results$significant, ]
print(paste0(nrow(sig), " significant proteins."))

no_mult_testing <- data_results[data_results$AD_vs_Control_p.val < 0.05, ]
no_mult_testing <- complete_cases[rownames(complete_cases) %in% no_mult_testing$name, ]
with_mult_testing <- data_results[data_results$AD_vs_Control_p.adj < 0.05, ]
with_mult_testing <- complete_cases[rownames(complete_cases) %in% with_mult_testing$name, ]
datatable_download(data_results)
```

```{r}
Heatmap(
  assay(complete_cases),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(complete_cases)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)

Heatmap(
  assay(no_mult_testing),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(no_mult_testing)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)

Heatmap(
  assay(with_mult_testing),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(with_mult_testing)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)
```

# AD2 Removal (MAR Imputation = KNN)

## Prep

```{r}
data <- read.csv(file.path(assets_dir, data_name, "data_comb_steph.csv"), row.names = "Gene.names_")
design <- read.csv(file.path(assets_dir, data_name, "comb_steph_newexp_design.csv"))

data[ , grep("AD_5365", colnames(data))] <- NULL
design <- design[-which(design$label == "AD_5365"), ]

data <- make_unique(data, "Gene.names", "Protein.IDs.x", ";")
LFQ_columns <- grep("Intensity.", colnames(data))

data <- make_se(data, LFQ_columns, design)
# colnames(data) <- gsub("^.*?_", "", colnames(data)) # Remove redundant labels. # TODO: Fix this.
data
```

**Unaltered data, already log2 transformed.**

```{r}
datatable_download(assay(data))
```

**After removal of log transformation.**

```{r}
datatable_download(2 ^ assay(data))
```

## QC

### Histogram

```{r}
hist(assay(data), n = 100)
```

### Missing Value Removal

```{r}
# assay(data) <- 2 ^ assay(data) # Undo log transformation.

discard <- which(
  is.na(rowMeans(assay(data)[ , 1:ceiling(ncol(data) / 2)], na.rm = TRUE))
)
data <- data[-discard, ]
discard <- which(
  is.na(rowMeans(assay(data)[ , (ceiling(ncol(data) / 2) + 1):ncol(data)], na.rm = TRUE))
)
data <- data[-discard, ]

data <- data[order(rowMeans(assay(data), na.rm = TRUE)), ]

plot_numbers(data)
plot_frequency(data)
plot_detect(data)
```

```{r, fig.height = 30}
plot_missval_custom(data)

complete_cases <- filter_proteins(data, "complete")

missing_data <- assay(data) %>% data.frame(.)
missing_data <- ifelse(is.na(missing_data), 0, 1)
discard <- which(
  rowSums(
    missing_data[ , 1:ceiling(ncol(missing_data) / 2)], na.rm = TRUE
  ) <= 4
)
data <- data[-discard, ]
print(paste0("Removed ", length(discard), " proteins from AD group."))

missing_data <- assay(data) %>% data.frame(.)
missing_data <- ifelse(is.na(missing_data), 0, 1)
discard <- which(
  rowSums(
    missing_data[ , (ceiling(ncol(missing_data) / 2) + 1):ncol(missing_data)], na.rm = TRUE
  ) <= 4
)
data <- data[-discard, ]
print(paste0("Removed ", length(discard), " proteins from Control group."))

data <- data[sort(rownames(data)), ]
AD_order <- order(
  rowMeans(assay(data)[ , 1:ceiling(ncol(data) / 2)], na.rm = TRUE)
)
data <- data[AD_order, ]
AD_MNAR <- rownames(data)[1:which(rownames(data) == "IMPA1")]
plot_missval_custom(data)

data <- data[sort(rownames(data)), ]
Control_order <- order(
  rowMeans(assay(data)[ , (ceiling(ncol(data) / 2) + 1):ncol(data)], na.rm = TRUE)
)
data <- data[Control_order, ]
Control_MNAR <- rownames(data)[1:which(rownames(data) == "FRRS1L")]
plot_missval_custom(data)
```

```{r}
missing_data <- assay(data) %>% data.frame(.)
missing_data <- missing_data[apply(missing_data, 1, function(x) any(is.na(x))), ]

plot_numbers(data)
plot_frequency(data)
plot_detect(data)
```

**Data before normalization but after removal of missing values.**

```{r}
datatable_download(assay(data))
```

**Complete cases before normalization but after removal of missing values.**

```{r}
datatable_download(assay(complete_cases))
```

### Normalization

```{r}
VSN_Normalized <- normalize_vsn(data)
Log_Transform_Only <- data

VSN_Normalized_Non_Missing_Data <- normalize_vsn(complete_cases)
Log_Transform_Only_Non_Missing_Data <- complete_cases

print("Log_Transform_Only")
meanSdPlot(Log_Transform_Only)
print("Log_Transform_Only_Non_Missing_Data")
meanSdPlot(Log_Transform_Only_Non_Missing_Data)
print("VSN_Normalized")
meanSdPlot(VSN_Normalized)
print("VSN_Normalized_Non_Missing_Data")
meanSdPlot(VSN_Normalized_Non_Missing_Data)

plot_normalization(Log_Transform_Only, VSN_Normalized)
plot_normalization(Log_Transform_Only_Non_Missing_Data, VSN_Normalized_Non_Missing_Data)

data <- VSN_Normalized
complete_cases <- VSN_Normalized_Non_Missing_Data
rm(
  VSN_Normalized, VSN_Normalized_Non_Missing_Data,
  Log_Transform_Only, Log_Transform_Only_Non_Missing_Data
)
```

```{r, fig.height = 30}
data <- data[sort(rownames(data)), ]
data <- data[AD_order, ]
plot_missval_custom(data)

data <- data[sort(rownames(data)), ]
data <- data[Control_order, ]
plot_missval_custom(data)
```

**Data after normalization and log2 transformation.**

```{r}
datatable_download(assay(data))
```

### Missing Value Imputation

```{r}
Unimputed_Data <- data
Non_Missing_data <- complete_cases
plot_imputation(Unimputed_Data, Non_Missing_data)
rm(Non_Missing_data)

impute1 <- data[ , 1:ceiling(ncol(data) / 2)]
impute_vector <- rownames(impute1) %in% AD_MNAR
set.seed(1)
impute1 <- impute(impute1, "mixed", randna = !impute_vector, mar = "knn", mnar = "MinDet")

impute2 <- data[ , (ceiling(ncol(data) / 2) + 1):ncol(data)]
impute_vector <- rownames(impute2) %in% Control_MNAR
set.seed(1)
impute2 <- impute(impute2, "mixed", randna = !impute_vector, mar = "knn", mnar = "MinDet")

Imputed_Data <- data
assay(Imputed_Data) <- cbind(assay(impute1), assay(impute2))

plot_imputation(Imputed_Data)

data <- Imputed_Data
rm(impute1, impute2)
```

```{r, fig.height = 30}
data <- data[sort(rownames(data)), ]
data <- data[AD_order, ]
heatmap_data <- data[rownames(data) %in% rownames(missing_data), ]
Heatmap(
  assay(heatmap_data),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(heatmap_data)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  cluster_rows = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)

data <- data[sort(rownames(data)), ]
data <- data[Control_order, ]
heatmap_data <- data[rownames(data) %in% rownames(missing_data), ]
Heatmap(
  assay(heatmap_data),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(heatmap_data)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  cluster_rows = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)
```

```{r}
plot_normalization(Unimputed_Data, Imputed_Data)
print("Unimputed Data")
meanSdPlot(Unimputed_Data)
print("Imputed Data")
meanSdPlot(Imputed_Data)

rm(Imputed_Data, heatmap_data)
```

**Data after missing value imputation.**
**This is final form used for differential expression analysis**

```{r}
datatable_download(assay(data))
```

### PCA

```{r}
plot_pca(data, indicate = c("condition", "label"), label = TRUE) +
  scale_shape_manual(values = seq(0, ncol(data)))
```

## Differential Expression

The results below are filtered for significance ($adjP < 0.05$).

```{r}
hvp <- apply(assay(data), 1, sd)
hvp <- hvp[order(hvp, decreasing = TRUE)]
hvp <- hvp[1:500]
hvp <- data[rownames(data) %in% names(hvp), ]

hvp <- add_rejections(test_diff(hvp, "control", "Control"), lfc = 0)
data_results <- get_results(hvp)
sig <- data_results[data_results$significant, ]
print(paste0(nrow(sig), " significant proteins."))

no_mult_testing <- data_results[data_results$AD_vs_Control_p.val < 0.05, ]
no_mult_testing <- hvp[rownames(hvp) %in% no_mult_testing$name, ]
datatable_download(data_results)
```

```{r, fig.height = 30}
Heatmap(
  assay(data),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(data)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)

Heatmap(
  assay(hvp),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(hvp)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)

Heatmap(
  assay(no_mult_testing),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(no_mult_testing)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)

missing_no_mult_testing <- no_mult_testing[rownames(no_mult_testing) %in% rownames(missing_data), ]
heatmap <- Heatmap(
  assay(missing_no_mult_testing),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(missing_no_mult_testing)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)
draw(heatmap)

unimputed_missing_no_mult_testing <- Unimputed_Data[
  rownames(Unimputed_Data) %in% rownames(missing_no_mult_testing),
]
Heatmap(
  assay(unimputed_missing_no_mult_testing),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(missing_no_mult_testing)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_order = row_order(heatmap),
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)
```

## Non-Missing Data

### PCA

```{r}
plot_pca(
  complete_cases, n = dim(complete_cases)[1], indicate = c("condition", "label"), label = TRUE
  ) + scale_shape_manual(values = seq(0, ncol(data)))
```

### Differential Expression

```{r}
complete_cases <- add_rejections(test_diff(complete_cases, "control", "Control"), lfc = 0)
data_results <- get_results(complete_cases)
sig <- data_results[data_results$significant, ]
print(paste0(nrow(sig), " significant proteins."))

no_mult_testing <- data_results[data_results$AD_vs_Control_p.val < 0.05, ]
no_mult_testing <- complete_cases[rownames(complete_cases) %in% no_mult_testing$name, ]
with_mult_testing <- data_results[data_results$AD_vs_Control_p.adj < 0.05, ]
with_mult_testing <- complete_cases[rownames(complete_cases) %in% with_mult_testing$name, ]
datatable_download(data_results)
```

```{r}
Heatmap(
  assay(complete_cases),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(complete_cases)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)

Heatmap(
  assay(no_mult_testing),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(no_mult_testing)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)

Heatmap(
  assay(with_mult_testing),
  colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(round(max(assay(with_mult_testing)))),
  column_names_side = "top",
  show_column_names = TRUE,
  cluster_columns = FALSE,
  row_names_side = "left",
  heatmap_legend_param = list(
    title = "log2 Intensity", title_position = "leftcenter-rot"
  ),
  row_names_gp = gpar(fontsize = 6),
  column_names_gp = gpar(fontsize = 16)
)
```

# References

This is the concluding section of the document, where we output the `sessionInfo`, and create a bibliography for works cited.

```{r}
sessionInfo()
```
