---
title: "Combined AD CTRL"
author:
  - name: "Emir, Pal, and Steph"
date: '`r strftime(Sys.time(), "%B %d, %Y")`'
bibliography: "../AD-CBD-exosome-proteins.bib"
link-citations: true
output:
  html_document:
    code_folding: hide
    number_sections: true
    theme: lumen
    highlight: haddock
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: false
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(
    "..", "results", "combined-AD-CTRL.html"
  ))})
---

<style type="text/css">
body {font-size: 16px;}
h1.title {font-size: 35px;}
h1 {font-size: 24px;}
h2 {font-size: 22px;}
h3 {font-size: 20px;}
.toc-content {padding-left: 0px; padding-right: 0px;}
div.tocify {width: 100%;}
.tocify-subheader .tocify-item {font-size: 0.95em; padding-left: 25px; text-indent: 0;}
.tocify-subheader .tocify-subheader .tocify-item {
  font-size: 0.95em; padding-left: 35px; text-indent: 0;
}
div.main-container {max-width: none; width: 100%;}
</style>

*This file is a part of [AD-CBD-exosome-proteins](https://github.com/eturkes/AD-CBD-exosome-proteins).*
*Please email me for access.*

The data here is derived from @combined and will be referenced using the name `combined`.

```{r}
# Copyright 2019-2020 Emir Turkes, Stephanie Fowler, Guar Pallavi, UK DRI at UCL,
# Columbia University Medical Center
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
#     http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# This section should be checked per document.
# --------------------------------------------
options(stringsAsFactors = FALSE)
packages <- c(
  "RColorBrewer", "dplyr", "DEP", "SummarizedExperiment",
  "ggplot2", "DT", "EnhancedVolcano", "purrr"
)
invisible(suppressPackageStartupMessages(lapply(packages, library, character.only = TRUE)))
source(file.path(getwd(), "utils.R"))

data_name <- "combined"
color <- colorRampPalette(rev(brewer.pal(7, "RdBu")))(100)
color_legend <- c("lightgray", "darkgray")
`%notin%` <- Negate(`%in%`)
# --------------------------------------------

# Everything else in this chunk remains generally unchanged.
# ----------------------------------------------------------
assets_dir <- file.path(getwd(), "..", "assets") # Backed up data.

cache_dir <- file.path(getwd(), "..", "tmp", "cache")
if (!dir.exists(cache_dir)) {
  dir.create(cache_dir, recursive = TRUE)
}

knitr::opts_chunk$set(fig.width = 10, fig.height = 7)
```

# All Data

## Prep

```{r}
data <- read.csv(file.path(assets_dir, data_name, "data_comb_steph.csv"), row.names = "Gene.names_")
design <- read.csv(file.path(assets_dir, data_name, "comb_steph_newexp_design.csv"))

data <- make_unique(data, "Gene.names", "Protein.IDs.x", ";")
LFQ_columns <- grep("Intensity.", colnames(data))

data <- make_se(data, LFQ_columns, design)
# colnames(data) <- gsub("^.*?_", "", colnames(data)) # Remove redundant labels. # TODO: Fix this.
data
```

**Unaltered data, already log2 transformed.**

```{r}
datatable_download(assay(data))
```

**After removal of log transformation.**

```{r}
datatable_download(2 ^ assay(data))
```

## QC

### Histogram

```{r}
hist(assay(data), n = 100)
```

### Missing Value Removal

```{r}
assay(data) <- 2 ^ assay(data) # Undo log transformation.

plot_numbers(data)
plot_frequency(data)
plot_missval(data)

complete_cases <- filter_proteins(data, "complete")
data <- filter_proteins(data, "condition", 4)

plot_missval(data)
plot_numbers(data)
plot_frequency(data)
```

**Data before normalization but after removal of missing values.**

```{r}
datatable_download(assay(data))
```

**Complete cases before normalization but after removal of missing values.**

```{r}
datatable_download(assay(complete_cases))
```

### Normalization

```{r}
data_norm <- data
data_norm_mat <- vsn::justvsn(assay(data_norm))
assay(data_norm) <- data_norm_mat
data_log <- data
assay(data_log) <- log2(assay(data))

complete_cases_norm <- complete_cases
complete_cases_norm_mat <- vsn::justvsn(assay(complete_cases_norm))
assay(complete_cases_norm) <- complete_cases_norm_mat
complete_cases_log <- complete_cases
assay(complete_cases_log) <- log2(assay(complete_cases))

meanSdPlot(data_log)
meanSdPlot(complete_cases_log)
meanSdPlot(data_norm)
meanSdPlot(complete_cases_norm)

plot_normalization(data_log, data_norm)
plot_normalization(complete_cases_log, complete_cases_norm)
```

```{r}
data <- data_norm
complete_cases <- complete_cases_norm
rm(data_norm, complete_cases_norm)
```

**Data after normalization.**

```{r}
datatable_download(assay(data))
```

**Complete cases after normalization.**

```{r}
datatable_download(assay(complete_cases))
```

### Missing Value Imputation

Using the QRILC method, which targets missing-not-at-random values AKA those that are likely missing due to being below the mass-spec quantification threshold.

```{r}
data_comb_norm <- data
no_imputation <- data_comb_norm
set.seed(1)
data_comb_imp_gaus <- DEP::impute(data_comb_norm, fun = "MinProb", q = 0.01)
set.seed(1)
data_comb_imp_mindet <- DEP::impute(data_comb_norm, fun = "MinDet", q = 0.01)
set.seed(1)
data_comb_imp_man <- DEP::impute(data_comb_norm, fun = "man", shift = 1.8, scale = 0.3)
set.seed(1)
data_comb_imp_knn <- DEP::impute(data_comb_norm, fun = "knn", rowmax = 0.9)
set.seed(1)
data_comb_imp_MLE <- DEP::impute(data_comb_norm, fun = "MLE")
set.seed(1)
data_comb_imp_zero <- DEP::impute(data_comb_norm, fun = "zero")
set.seed(1)
data_comb_imp_bpca <- DEP::impute(data_comb_norm, fun = "bpca")
set.seed(1)
data_comb_imp_min <- DEP::impute(data_comb_norm, fun = "min")

#Mixed imputation on proteins (rows)
proteins_MNAR <- get_df_long(data_comb_norm) %>%
  group_by(name, condition) %>%
  summarize(NAs = all(is.na(intensity))) %>% 
  filter(NAs) %>% 
  pull(name) %>% 
  unique()
# Get a logical vector
MNAR <- names(data_comb_norm) %in% proteins_MNAR
set.seed(1)
mixed_imputation <- DEP::impute(data_comb_norm, 
  fun = "mixed",
  randna = !MNAR,
  mar = "bpca",
  mnar = "zero")
head(mixed_imputation)

# SummarizedExperiment to MSnSet object conversion
sample_specific_imputation <- data_comb_norm
MSnSet <- as(sample_specific_imputation, "MSnSet")
# Impute differently for two sets of samples
set.seed(1)
MSnSet_imputed1 <- MSnbase::impute(MSnSet[, 1:9], method ="MLE" )
set.seed(1)
MSnSet_imputed2 <- MSnbase::impute(MSnSet[, 10:17], method = "MinProb")
# Combine into the SummarizedExperiment object
assay(sample_specific_imputation) <- cbind(
  MSnbase::exprs(MSnSet_imputed1), 
  MSnbase::exprs(MSnSet_imputed2))

set.seed(1)
data_comb_imp_qrilc <- impute(data_comb_norm, "QRILC")
```

```{r}
meanSdPlot(data_comb_imp_gaus)
meanSdPlot(data_comb_imp_mindet)
meanSdPlot(data_comb_imp_man)
meanSdPlot(data_comb_imp_knn)
meanSdPlot(data_comb_imp_MLE)
meanSdPlot(data_comb_imp_zero)
meanSdPlot(data_comb_imp_bpca)
meanSdPlot(data_comb_imp_min)
meanSdPlot(data_comb_imp_qrilc)
```

### Plot intensity distributions before and after imputation{.tabset}
##### With Guas (MinProb)
```{r }
plot_imputation(data_comb_norm, data_comb_imp_gaus)
plot_imputation(data_comb_norm, data_comb_imp_mindet)
plot_imputation(data_comb_norm, data_comb_imp_man)
plot_imputation(data_comb_norm, data_comb_imp_knn)
plot_imputation(data_comb_norm, data_comb_imp_MLE)
plot_imputation(data_comb_norm, data_comb_imp_bpca)
plot_imputation(data_comb_norm, data_comb_imp_zero)
plot_imputation(data_comb_norm, data_comb_imp_min)
plot_imputation(data_comb_norm, data_comb_imp_qrilc)
plot_imputation(data_comb_norm, mixed_imputation)
plot_imputation(data_comb_norm, sample_specific_imputation)
```

##Differential enrichment analysis
#### Test AD versus control (separately for all three imputation methods)
This is based on linear models and empherical Bayes statistics
```{r}
data_comb_diff_no <- test_diff(no_imputation, type = "control", control = "Control")
data_comb_diff_gaus <- test_diff(data_comb_imp_gaus, type = "control", control = "Control")
data_comb_diff_mindet <- test_diff(data_comb_imp_mindet, type = "control", control = "Control")
data_comb_diff_man <- test_diff(data_comb_imp_man, type = "control", control = "Control")
data_comb_diff_knn <- test_diff(data_comb_imp_knn, type = "control", control = "Control")
data_comb_diff_MLE <- test_diff(data_comb_imp_MLE, type = "control", control = "Control")
data_comb_diff_bpca <- test_diff(data_comb_imp_bpca, type = "control", control = "Control")
data_comb_diff_zero <- test_diff(data_comb_imp_zero, type = "control", control = "Control")
data_comb_diff_min<- test_diff(data_comb_imp_min, type = "control", control = "Control")
data_comb_diff_mixed <- test_diff(mixed_imputation, type = "control", control = "Control")
data_comb_diff_samplespec<-test_diff(sample_specific_imputation, type = "control", control = "Control")
data_comb_diff_compcase <- test_diff(complete_cases, type = "control", control = "Control")

#Find out the proteins having p-adj values of 0.05 and fold change of 1.6
dep_comb_no <- add_rejections(data_comb_diff_no, alpha = 0.05, lfc = log2(0.8))
dep_comb_gaus <- add_rejections(data_comb_diff_gaus, alpha = 0.05, lfc = log2(0.8))
dep_comb_mindet<-add_rejections(data_comb_diff_mindet, alpha = 0.05, lfc = log2(0.8))
dep_comb_man <- add_rejections(data_comb_diff_man, alpha = 0.05, lfc = log2(0.8))
dep_comb_knn <- add_rejections(data_comb_diff_knn, alpha = 0.05, lfc = log2(0.8))
dep_comb_MLE <- add_rejections(data_comb_diff_MLE, alpha = 0.05, lfc = log2(0.8))
dep_comb_bpca <- add_rejections(data_comb_diff_bpca, alpha = 0.05, lfc = log2(0.8))
dep_comb_zero <- add_rejections(data_comb_diff_zero, alpha = 0.05, lfc = log2(0.8))
dep_comb_min <- add_rejections(data_comb_diff_min, alpha = 0.05, lfc = log2(0.8))
dep_comb_mixed <- add_rejections(data_comb_diff_mixed, alpha = 0.05, lfc = log2(0.8))
dep_comb_samplespec <- add_rejections(data_comb_diff_samplespec, alpha = 0.05, lfc = log2(0.8))
dep_comb_compcase <- add_rejections(data_comb_diff_compcase, alpha = 0.05, lfc = log2(0.8))
```


### Plot the first and second principal components (top 500){.tabset}
##### With gaus(MinProb-MNAR){.tabset}
```{r }
plot_pca(dep_comb_gaus,x = 1, y = 2, n = 500,indicate = c("condition", "label"), point_size = 4,label = T)+scale_shape_manual(values = rep(1:17, len = 17))
```

##### With MinDet(MNAR){.tabset}
```{r }
plot_pca(dep_comb_mindet,x = 1, y = 2, n = 500,indicate = c("condition", "label"), point_size = 4,label = T)+scale_shape_manual(values = rep(1:17, len = 17))
```

##### With manual gaus{.tabset}
```{r }
plot_pca(dep_comb_man, x = 1, y = 2, n = 500,indicate = c("condition", "label"), point_size = 4,label = T)+scale_shape_manual(values = rep(1:17, len = 17))
#+  geom_text(label = rownames(design_comb))
```

##### With KNN(MAR) {.tabset}
```{r }
plot_pca(dep_comb_knn, x = 1, y = 2, n = 500,indicate = c("condition", "label"), point_size = 4,label = T)+scale_shape_manual(values = rep(1:17, len = 17))
```

##### With MLE(MAR) {.tabset}
```{r }
plot_pca(dep_comb_MLE, x = 1, y = 2, n = 500,indicate = c("condition", "label"), point_size = 4,label = T)+scale_shape_manual(values = rep(1:17, len = 17))
```

##### With BPCA(Bayesian MAR) {.tabset}
```{r }
plot_pca(dep_comb_bpca, x = 1, y = 2, n = 500,indicate = c("condition", "label"), point_size = 4,label = T)+scale_shape_manual(values = rep(1:17, len = 17))
```

##### With Zero {.tabset}
```{r }
plot_pca(dep_comb_zero, x = 1, y = 2, n = 500,indicate = c("condition", "label"), point_size = 4,label = T)+scale_shape_manual(values = rep(1:17, len = 17))
```

##### With Min {.tabset}
```{r }
plot_pca(dep_comb_min, x = 1, y = 2, n = 500,indicate = c("condition", "label"), point_size = 4,label = T)+scale_shape_manual(values = rep(1:17, len = 17))
```

##### With mixed on proteins {.tabset}
```{r }
plot_pca(dep_comb_mixed, x = 1, y = 2, n = 500,indicate = c("condition", "label"), point_size = 4,label = T)+scale_shape_manual(values = rep(1:17, len = 17))
```

##### With mixed on samples{.tabset}
```{r }
plot_pca(dep_comb_samplespec, x = 1, y = 2, n = 500,indicate = c("condition", "label"), point_size = 4,label = T)+scale_shape_manual(values = rep(1:17, len = 17))
```

##### With complete cases i.e. no imputation needed{.tabset}
```{r }
plot_pca(dep_comb_compcase, x = 1, y = 2, n = 200,indicate = c("condition", "label"), point_size = 4,label = T)+scale_shape_manual(values = rep(1:17, len = 17))
```


### Correlation plots{.tabset}
##### With gaus(MNAR){.tabset}
```{r }
plot_cor(dep_comb_gaus , significant = T, lower = 0, upper = 1, pal = "Reds")
```

##### With MinDet(MNAR){.tabset}
```{r }
plot_cor(dep_comb_mindet , significant = T, lower = 0, upper = 1, pal = "Reds")
```

##### With manual gaus(MNAR){.tabset}
```{r }
plot_cor(dep_comb_man , significant = T, lower = 0, upper = 1, pal = "Reds")
```

##### With KNN(MAR){.tabset}
With all proteins, not only significant ones like others
```{r }
plot_cor(dep_comb_knn , significant = F, lower = 0, upper = 1, pal = "Reds")
```

##### With MLE(MAR){.tabset}
With all proteins, not only significant ones like others
```{r }
plot_cor(dep_comb_MLE , significant = F, lower = 0, upper = 1, pal = "Reds")
```

##### With BPCA(MAR){.tabset}
With all proteins, not only significant ones like others
```{r }
plot_cor(dep_comb_bpca , significant = F, lower = 0, upper = 1, pal = "Reds")
```

##### With Zero{.tabset}
With all proteins, not only significant ones like others
```{r }
plot_cor(dep_comb_zero , significant = T, lower = 0, upper = 1, pal = "Reds")
```

##### With Minimum{.tabset}
With all proteins, not only significant ones like others
```{r }
plot_cor(dep_comb_min , significant = F,lower = 0, upper = 1, pal = "Reds")
```

##### With mixed on proteins{.tabset}
With all proteins, not only significant ones like others
```{r }
plot_cor(dep_comb_mixed , significant = F, lower = 0, upper = 1, pal = "Reds")
```

##### With mixed on samples{.tabset}
```{r }
plot_cor(dep_comb_samplespec , significant = F, lower = 0, upper = 1, pal = "Reds")
```

##### With complete cases{.tabset}
```{r }
plot_cor(dep_comb_compcase , significant = T, lower = 0, upper = 1, pal = "Reds")
```


### Heatmap of all significant proteins with the data centered per protein {.tabset}
##### With gaus(MinProb-MNAR){.tabset}
```{r }
plot_heatmap(dep_comb_gaus, type = "centered", kmeans = TRUE, 
             k = 2, col_limit = 4, show_row_names = T,
             indicate = c("condition", "replicate"))
```  

##### With MinDet(MNAR){.tabset}
```{r }
plot_heatmap(dep_comb_mindet, type = "centered", kmeans = TRUE, 
             k = 2, col_limit = 4, show_row_names = T,
             indicate = c("condition", "replicate"))
```  

##### With manual gaus(MNAR){.tabset}
```{r }
plot_heatmap(dep_comb_man, type = "centered", kmeans = TRUE, 
             k = 2, col_limit = 4, show_row_names = T,
             indicate = c("condition", "replicate"))
```            
             
##### With KNN(MAR){.tabset}
```{r }
plot_heatmap(dep_comb_knn, type = "centered", kmeans = F, 
              col_limit = 4, show_row_names = T,
             indicate = c("condition", "replicate"))
```   

##### With MLE(MAR){.tabset}
```{r }
plot_heatmap(dep_comb_MLE, type = "centered", kmeans = F, 
              col_limit = 4, show_row_names = T,
             indicate = c("condition", "replicate"))
```   

##### With BPCA(MAR){.tabset}
```{r }
plot_heatmap(dep_comb_bpca, type = "centered", kmeans = F, 
             k = 2, col_limit = 4, show_row_names = T,
             indicate = c("condition", "replicate"))
```   

##### With Zero{.tabset}
```{r }
plot_heatmap(dep_comb_zero, type = "centered", kmeans = T, 
             k = 2, col_limit = 15, show_row_names = T,
             indicate = c("condition", "replicate"))
```  

##### With Minimum{.tabset}
```{r }
plot_heatmap(dep_comb_min, type = "centered", kmeans = T, 
             k = 2, col_limit = 4, show_row_names = T,
             indicate = c("condition", "replicate"))
```  

##### With mixed on proteins{.tabset}
```{r }
plot_heatmap(dep_comb_mixed, type = "centered", kmeans = TRUE, 
             k = 2, col_limit = 4, show_row_names = T,
             indicate = c("condition", "replicate"))
```  

##### With mixed on samples{.tabset}
```{r }
plot_heatmap(dep_comb_samplespec, type = "centered", kmeans = T, 
             k=4, col_limit = 4, show_row_names = T,
             indicate = c("condition", "replicate"))
```  
           

##### With complete cases{.tabset}
```{r }
plot_heatmap(dep_comb_compcase, type = "centered", kmeans = TRUE, 
             k = 4, col_limit = 4, show_row_names = T,
             indicate = c("condition", "replicate"))
```  


### Volcano plots {.tabset}
##### No imputation {.tabset}
```{r }
data_comb_results_no<- get_results(dep_comb_no)

EnhancedVolcano(data_comb_results_no,
                lab = data_comb_results_no$name,
                x = 'AD_vs_Control_ratio',
                y = 'AD_vs_Control_p.val',
                xlim=c(-6,6),
                xlab = bquote(~Log[2]~ 'fold change'),
                ylab = bquote(~-Log[10]~adjusted~italic(P)),
                pCutoff = 0.05,
                FCcutoff = 1,
                labSize = 4.0,drawConnectors = F,
                colAlpha = 1,
                col = c('#D1E5F0',"#4393C3","#F4A582","#B2182B"),
                legend=c('NS','Log2 FC',' p-value',
                         ' p-value & Log2 FC'),
                legendPosition = 'bottom',
                legendLabSize = 10,
                legendIconSize = 3.0,
                title = "volcano_no_imputation_comb_pval0.05_lfc_1")
```

##### With gaus(MinProb-MNAR){.tabset}
```{r }
data_comb_results_gaus<- get_results(dep_comb_gaus)
EnhancedVolcano(data_comb_results_gaus,
                lab = data_comb_results_gaus$name,
                x = 'AD_vs_Control_ratio',
                y = 'AD_vs_Control_p.val',
                xlim=c(-6,6),
                xlab = bquote(~Log[2]~ 'fold change'),
                ylab = bquote(~-Log[10]~adjusted~italic(P)),
                pCutoff = 0.05,
                FCcutoff = 1,
                labSize = 4.0,drawConnectors = F,
                colAlpha = 1,
                col = c('#D1E5F0',"#4393C3","#F4A582","#B2182B"),
                legend=c('NS','Log2 FC',' p-value',
                         ' p-value & Log2 FC'),
                legendPosition = 'bottom',
                legendLabSize = 10,
                legendIconSize = 3.0,
                title = "volcano_comb_Gaus_MinProb_pval0.05_lfc_1")
```

##### With MinDet-MNAR{.tabset}
```{r }
data_comb_results_mindet<- get_results(dep_comb_mindet)

EnhancedVolcano(data_comb_results_mindet,
                lab = data_comb_results_mindet$name,
                x = 'AD_vs_Control_ratio',
                y = 'AD_vs_Control_p.val',
                xlim=c(-6,6),
                xlab = bquote(~Log[2]~ 'fold change'),
                ylab = bquote(~-Log[10]~adjusted~italic(P)),
                pCutoff = 0.05,
                FCcutoff = 1,
                labSize = 4.0,drawConnectors = F,
                colAlpha = 1,
                col = c('#D1E5F0',"#4393C3","#F4A582","#B2182B"),
                legend=c('NS','Log2 FC',' p-value',
                         ' p-value & Log2 FC'),
                legendPosition = 'bottom',
                legendLabSize = 10,
                legendIconSize = 3.0,
                title = "volcano_MinDet_comb_pval0.05_lfc_1")
```

##### With manual gaus{.tabset}
```{r }
data_comb_results_man<- get_results(dep_comb_man)
EnhancedVolcano(data_comb_results_man,
                lab = data_comb_results_man$name,
                x = 'AD_vs_Control_ratio',
                y = 'AD_vs_Control_p.val',
                xlim=c(-6,6),
                xlab = bquote(~Log[2]~ 'fold change'),
                ylab = bquote(~-Log[10]~adjusted~italic(P)),
                pCutoff = 0.05,
                FCcutoff = 1,
                labSize = 4.0,drawConnectors = F,
                colAlpha = 1,
                col = c('#D1E5F0',"#4393C3","#F4A582","#B2182B"),
                legend=c('NS','Log2 FC',' p-value',
                         ' p-value & Log2 FC'),
                legendPosition = 'bottom',
                legendLabSize = 10,
                legendIconSize = 3.0,
                title = "volcano_manual_gaus_comb_pval0.05_lfc_1")
```

##### With KNN(MAR){.tabset}
```{r }
data_comb_results_knn<- get_results(dep_comb_knn)
EnhancedVolcano(data_comb_results_knn,
                lab = data_comb_results_knn$name,
                x = 'AD_vs_Control_ratio',
                y = 'AD_vs_Control_p.val',
                xlim=c(-6,6),
                xlab = bquote(~Log[2]~ 'fold change'),
                ylab = bquote(~-Log[10]~adjusted~italic(P)),
                pCutoff = 0.05,
                FCcutoff = 1,
                labSize = 4.0,drawConnectors = F,
                colAlpha = 1,
                col = c('#D1E5F0',"#4393C3","#F4A582","#B2182B"),
                legend=c('NS','Log2 FC',' p-value',
                         ' p-value & Log2 FC'),
                legendPosition = 'bottom',
                legendLabSize = 10,
                legendIconSize = 3.0,
                title = "volcano_KNN_comb_pval0.05_lfc_1")
```

##### With MLE (MAR){.tabset}
```{r }
data_comb_results_MLE<- get_results(dep_comb_MLE)
EnhancedVolcano(data_comb_results_MLE,
                lab = data_comb_results_MLE$name,
                x = 'AD_vs_Control_ratio',
                y = 'AD_vs_Control_p.val',
                xlim=c(-6,6),
                xlab = bquote(~Log[2]~ 'fold change'),
                ylab = bquote(~-Log[10]~italic(P)),
                pCutoff = 0.05,
                FCcutoff = 1,
                labSize = 4.0,drawConnectors = F,
                colAlpha = 1,
                col = c('#D1E5F0',"#4393C3","#F4A582","#B2182B"),
                legend=c('NS','Log2 FC',' p-value',
                         ' p-value & Log2 FC'),
                legendPosition = 'bottom',
                legendLabSize = 10,
                legendIconSize = 3.0,
                title = "volcano_MLW_comb_pval0.05_lfc_1")
```

##### With bpca (MAR){.tabset}
```{r }
data_comb_results_bpca<- get_results(dep_comb_bpca)
EnhancedVolcano(data_comb_results_bpca,
                lab = data_comb_results_bpca$name,
                x = 'AD_vs_Control_ratio',
                y = 'AD_vs_Control_p.val',
                xlim=c(-6,6),
                xlab = bquote(~Log[2]~ 'fold change'),
                ylab = bquote(~-Log[10]~italic(P)),
                pCutoff = 0.05,
                FCcutoff = 1,
                labSize = 4.0,drawConnectors = F,
                colAlpha = 1,
                col = c('#D1E5F0',"#4393C3","#F4A582","#B2182B"),
                legend=c('NS','Log2 FC',' p-value',
                         ' p-value & Log2 FC'),
                legendPosition = 'bottom',
                legendLabSize = 10,
                legendIconSize = 3.0,
                title = "volcano_BPCA_comb_pval0.05_lfc_1")
```

##### With Zero{.tabset}
```{r }
data_comb_results_zero<- get_results(dep_comb_zero)
EnhancedVolcano(data_comb_results_zero,
                lab = data_comb_results_zero$name,
                x = 'AD_vs_Control_ratio',
                y = 'AD_vs_Control_p.val',
                xlim=c(-6,6),
                xlab = bquote(~Log[2]~ 'fold change'),
                ylab = bquote(~-Log[10]~italic(P)),
                pCutoff = 0.05,
                FCcutoff = 1,
                labSize = 4.0,drawConnectors = F,
                colAlpha = 1,
                col = c('#D1E5F0',"#4393C3","#F4A582","#B2182B"),
                legend=c('NS','Log2 FC',' p-value',
                         ' p-value & Log2 FC'),
                legendPosition = 'bottom',
                legendLabSize = 10,
                legendIconSize = 3.0,
                title = "volcano_ZERO_comb_pval0.05_lfc_1")
```

##### With Minimum{.tabset}
```{r }
data_comb_results_min<- get_results(dep_comb_min)
EnhancedVolcano(data_comb_results_min,
                lab = data_comb_results_min$name,
                x = 'AD_vs_Control_ratio',
                y = 'AD_vs_Control_p.val',
                xlim=c(-6,6),
                xlab = bquote(~Log[2]~ 'fold change'),
                ylab = bquote(~-Log[10]~italic(P)),
                pCutoff = 0.05,
                FCcutoff = 1,
                labSize = 4.0,drawConnectors = F,
                colAlpha = 1,
                col = c('#D1E5F0',"#4393C3","#F4A582","#B2182B"),
                legend=c('NS','Log2 FC',' p-value',
                         ' p-value & Log2 FC'),
                legendPosition = 'bottom',
                legendLabSize = 10,
                legendIconSize = 3.0,
                title = "volcano_MINIMUM_comb_pval0.05_lfc_1")
```


##### With mixed imputation on proteins{.tabset}
```{r }
data_comb_results_mixed<- get_results(dep_comb_mixed)
EnhancedVolcano(data_comb_results_mixed,
                lab = data_comb_results_mixed$name,
                x = 'AD_vs_Control_ratio',
                y = 'AD_vs_Control_p.val',
                xlim=c(-6,6),
                xlab = bquote(~Log[2]~ 'fold change'),
                ylab = bquote(~-Log[10]~italic(P)),
                pCutoff = 0.05,
                FCcutoff = 1,
                labSize = 4.0,drawConnectors = F,
                colAlpha = 1,
                col = c('#D1E5F0',"#4393C3","#F4A582","#B2182B"),
                legend=c('NS','Log2 FC',' p-value',
                         ' p-value & Log2 FC'),
                legendPosition = 'bottom',
                legendLabSize = 10,
                legendIconSize = 3.0,
                title = "volcano_mixed_imput_on_proteins_comb_pval0.05_lfc_1")
```

##### With mixed imputation on samples{.tabset}
```{r }
data_comb_results_samplespec<- get_results(dep_comb_samplespec)
EnhancedVolcano(data_comb_results_samplespec,
                lab = data_comb_results_samplespec$name,
                x = 'AD_vs_Control_ratio',
                y = 'AD_vs_Control_p.val',
                xlim=c(-6,6),
                xlab = bquote(~Log[2]~ 'fold change'),
                ylab = bquote(~-Log[10]~italic(P)),
                pCutoff = 0.05,
                FCcutoff = 1,
                labSize = 4.0,drawConnectors = F,
                colAlpha = 1,
                col = c('#D1E5F0',"#4393C3","#F4A582","#B2182B"),
                legend=c('NS','Log2 FC',' p-value',
                         ' p-value & Log2 FC'),
                legendPosition = 'bottom',
                legendLabSize = 10,
                legendIconSize = 3.0,
                title = "volcano_mixed_imput_on_samples_comb_pval0.05_lfc_1")
```

##### With complete cases{.tabset}
```{r }
data_comb_results_compcase<- get_results(dep_comb_compcase)
EnhancedVolcano(data_comb_results_compcase,
                lab = data_comb_results_compcase$name,
                x = 'AD_vs_Control_ratio',
                y = 'AD_vs_Control_p.val',
                xlim=c(-6,6),
                xlab = bquote(~Log[2]~ 'fold change'),
                ylab = bquote(~-Log[10]~italic(P)),
                pCutoff = 0.05,
                FCcutoff = 1,
                labSize = 4.0,drawConnectors = F,
                colAlpha = 1,
                col = c('#D1E5F0',"#4393C3","#F4A582","#B2182B"),
                legend=c('NS','Log2 FC',' p-value',
                         ' p-value & Log2 FC'),
                legendPosition = 'bottom',
                legendLabSize = 10,
                legendIconSize = 3.0,
                title = "volcano_complete_cases_comb_pval0.05_lfc_1")
```


### Barplots of proteins of interest {.tabset}
##### With no imputation{.tabset}
```{r }
plot_single(dep_comb_no, proteins = c("MAPT", "APOE"),type = "centered")
```

##### With Gaus MinProb(MNAR){.tabset}
```{r }
plot_single(dep_comb_gaus, proteins = c("MAPT", "APOE"),type = "centered")
```

##### With Gaus MinDet(MNAR){.tabset}
```{r }
plot_single(dep_comb_gaus, proteins = c("MAPT", "APOE"),type = "centered")
```

##### With Manual gaus{.tabset}
```{r }
plot_single(dep_comb_man, proteins = c("MAPT", "APOE"),type = "centered")
```

##### With KNN(MAR){.tabset}
```{r }
plot_single(dep_comb_knn, proteins = c("MAPT", "APOE"),type = "centered")
```

##### With MLE(MAR){.tabset}
```{r }
plot_single(dep_comb_MLE, proteins = c("MAPT", "APOE"),type = "centered")
```

##### With bpca(MAR){.tabset}
```{r }
plot_single(dep_comb_bpca, proteins = c("MAPT", "APOE"),type = "centered")
```

##### With zero{.tabset}
```{r }
plot_single(dep_comb_zero, proteins = c("MAPT", "APOE"),type = "centered")
```

##### With minimum{.tabset}
```{r }
plot_single(dep_comb_min, proteins = c("MAPT", "APOE"),type = "centered")
```

##### With mixed imputation on proteins{.tabset}
```{r }
plot_single(dep_comb_mixed, proteins = c("MAPT", "APOE"),type = "centered")
```

##### With mixed imputation on samples{.tabset}
```{r }
plot_single(dep_comb_samplespec, proteins = c("MAPT", "APOE"),type = "centered")
```

##### With complete cases{.tabset}
```{r }
plot_single(dep_comb_compcase, proteins = c("MAPT", "APOE"),type = "centered")
```


### Number of Significant proteins (p-adj value based){.tabset}
##### With no imputation{.tabset}
Number of significant proteins
```{r }
# Number of significant proteins
data_comb_results_no %>% filter(significant) %>% nrow()
```

##### With Gaus{.tabset}
Number of significant proteins
```{r }
# Number of significant proteins
data_comb_results_gaus %>% filter(significant) %>% nrow()
```

##### With (MinDet-MNAR){.tabset}
Number of significant proteins
```{r }
# Number of significant proteins
data_comb_results_mindet %>% filter(significant) %>% nrow()

```

##### With manual gaus{.tabset}
Number of significant proteins
```{r }
# Number of significant proteins
data_comb_results_man %>% filter(significant) %>% nrow()
```

##### With KNN{.tabset}
Number of significant proteins
```{r }
# Number of significant proteins
data_comb_results_knn %>% filter(significant) %>% nrow()
```

##### With MLE{.tabset}
Number of significant proteins
```{r }
# Number of significant proteins
data_comb_results_MLE %>% filter(significant) %>% nrow()
```

##### With BPCA{.tabset}
Number of significant proteins
```{r }
# Number of significant proteins
data_comb_results_bpca %>% filter(significant) %>% nrow()
```

##### With Zero{.tabset}
Number of significant proteins
```{r }
# Number of significant proteins
data_comb_results_zero %>% filter(significant) %>% nrow()
```

##### With Minimum{.tabset}
Number of significant proteins
```{r }
# Number of significant proteins
data_comb_results_min %>% filter(significant) %>% nrow()
```

##### With Mixed imputation on proteins{.tabset}
Number of significant proteins
```{r }
# Number of significant proteins
data_comb_results_mixed %>% filter(significant) %>% nrow()
```

##### With Mixed imputation on Samples{.tabset}
Number of significant proteins
```{r }
# Number of significant proteinsdata_comb_results_compcase<- get_results(dep_comb_compcase)
data_comb_results_samplespec<-get_results(dep_comb_samplespec)
data_comb_results_samplespec %>% filter(significant) %>% nrow()
```

##### With complete case{.tabset}
Number of significant proteins
```{r }
# Number of significant proteins
data_comb_results_compcase%>% filter(significant) %>% nrow()
```


###Generate a results table{.tabset}
##### With no imputation{.tabset}
```{r }
# Number of significant proteins
data_comb_results_no %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

##### With Gaus{.tabset}
```{r }
data_comb_results_gaus %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

##### With (MinDet-MNAR){.tabset}
```{r }
data_comb_results_mindet %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))

```

##### With manual gaus{.tabset}
```{r }
data_comb_results_man %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

##### With KNN{.tabset}
```{r }
data_comb_results_knn %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

##### With MLE{.tabset}
```{r }
data_comb_results_MLE %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

##### With BPCA{.tabset}
```{r }
data_comb_results_bpca %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

##### With Zero{.tabset}
```{r }
data_comb_results_zero %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

##### With Minimum{.tabset}
```{r }
data_comb_results_min %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

##### With Mixed imputation on proteins{.tabset}
```{r }
data_comb_results_mixed %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

##### With Mixed imputation on Samples{.tabset}
```{r }
data_comb_results_mixed %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

##### With complete case{.tabset}
```{r }
data_comb_results_compcase %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```


###Volcano plots with adjusted p values{.tabset}
##### With no imputation{.tabset}
```{r }
plot_volcano(dep_comb_no, contrast = "AD_vs_Control", label_size = 2, add_names = TRUE)
```

##### With Gaus(MNAR){.tabset}
```{r }
plot_volcano(dep_comb_gaus, contrast = "AD_vs_Control", label_size = 2, add_names = TRUE)
```

##### With MinDet(MNAR){.tabset}
```{r }
plot_volcano(dep_comb_mindet, contrast = "AD_vs_Control", label_size = 2, add_names = TRUE)
```

##### With Manual Gaus(MNAR){.tabset}
```{r }
plot_volcano(dep_comb_man, contrast = "AD_vs_Control", label_size = 2, add_names = TRUE)
```

##### With KNN(MAR){.tabset}
```{r }
plot_volcano(dep_comb_knn, contrast = "AD_vs_Control", label_size = 2, add_names = TRUE)
```

##### With MLE(MAR){.tabset}
```{r }
plot_volcano(dep_comb_MLE, contrast = "AD_vs_Control", label_size = 2, add_names = TRUE)
```

##### With bpca(MAR){.tabset}
```{r }
plot_volcano(dep_comb_bpca, contrast = "AD_vs_Control", label_size = 2, add_names = TRUE)
```

##### With Zero{.tabset}
```{r }
plot_volcano(dep_comb_zero, contrast = "AD_vs_Control", label_size = 2, add_names = TRUE)
```

##### With Minimum{.tabset}
```{r }
plot_volcano(dep_comb_min, contrast = "AD_vs_Control", label_size = 2, add_names = TRUE)
```

##### With mixed imputation on proteins{.tabset}
```{r }
plot_volcano(dep_comb_mixed, contrast = "AD_vs_Control", label_size = 2, add_names = TRUE)
```

##### With mixed imputation on samples{.tabset}
```{r }
plot_volcano(dep_comb_samplespec, contrast = "AD_vs_Control", label_size = 2, add_names = TRUE)
```

##### With complete cases{.tabset}
```{r }
plot_volcano(dep_comb_compcase, contrast = "AD_vs_Control", label_size = 2, add_names = TRUE)
```


# Let's check the performance of all the imputation methods
```{r }
# Function to extract number of DE proteins
DE_prots <- function(results) {
  data_frame(Dataset = gsub("_results", "", results),
    significant_proteins = get(results) %>% 
      filter(significant) %>% 
      nrow())
}
#As an initial parameter we look at the number of differentially expressed proteins identified (adjusted P ≤ 0.05).
# Number of significant proteins
objects <- c( "data_comb_results_no",
              "data_comb_results_gaus",
              "data_comb_results_mindet",
              "data_comb_results_man",
            "data_comb_results_knn",
              "data_comb_results_MLE",
            "data_comb_results_bpca",
            "data_comb_results_zero",
            "data_comb_results_bpca",
"data_comb_results_mixed",
"data_comb_results_samplespec",
"data_comb_results_compcase")

map<-map_df(objects, DE_prots)
map
```


```{r }
get_ROC_df <- function(results) {
  get(results) %>% 
    dplyr::select(name, AD_vs_Control_p.val, AD_vs_Control_significant) %>% 
    mutate(
  DE = grepl("TRUE", AD_vs_Control_significant ),
      BG = grepl("FALSE", AD_vs_Control_significant)) %>% 
    arrange(AD_vs_Control_p.val) %>% 
    mutate(
      TPR = cumsum(as.numeric(DE)) /sum(DE),
      FPR = cumsum(as.numeric(BG)) / sum(BG),
      method = results)
}
```

```{r }
ROC_df <-map_df(objects, get_ROC_df)
ROC_df %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))

g<-ggplot(ROC_df, aes(FPR, TPR ,col = method)) +
  geom_line() +
  theme_DEP1() +
  ggtitle("ROC-curve")
g

g_zoom<-ggplot(ROC_df, aes(FPR ,TPR, col = method)) +
  geom_line() +
  theme_DEP1() +
  xlim(0, 0.1) +
  ggtitle("ROC-curve zoom")

g_zoom

```

# References

This is the concluding section of the document, where we output the `sessionInfo`, and create a bibliography for works cited.

```{r}
sessionInfo()
```
