---
title: "Imputation Simulation"
author:
  - name: "Emir Turkes and Stephanie Fowler"
date: '`r strftime(Sys.time(), "%B %d, %Y")`'
bibliography: "../AD-exosome-characterisation.bib"
link-citations: true
output:
  html_document:
    code_folding: hide
    number_sections: true
    theme: lumen
    highlight: haddock
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: false
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(
    "..", "results", "imputation-simulation.html"
  ))})
---

<style type="text/css">
body {font-size: 16px;}
h1.title {font-size: 35px;}
h1 {font-size: 24px;}
h2 {font-size: 22px;}
h3 {font-size: 20px;}
.toc-content {padding-left: 0px; padding-right: 0px;}
div.tocify {width: 100%;}
.tocify-subheader .tocify-item {font-size: 0.95em; padding-left: 25px; text-indent: 0;}
.tocify-subheader .tocify-subheader .tocify-item {
  font-size: 0.95em; padding-left: 35px; text-indent: 0;
}
div.main-container {max-width: none; width: 100%;}
</style>

*This file is a part of [AD-exosome-characterisation](https://github.com/eturkes/AD-exosome-characterisation).*
*Please email for access.*

```{r}
# Some standard boilerplate.
# --------------------------
#    This file is part of AD-exosome-characterisation.
#    Copyright (C) 2022  Emir Turkes, Stephanie Fowler, UK DRI at UCL, Columbia
#    University Medical Center
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
#    Emir Turkes can be contacted at emir.turkes@eturkes.com

# This section should be checked per document.
# --------------------------------------------
packages <- c(
  "conflicted", "circlize", "dplyr", "DEP", "SummarizedExperiment", "scales", "ggplot2", "DT",
  "ComplexHeatmap", "volcano3D", "RColorBrewer", "limma", "tibble", "readxl", "khroma", "mice"
)
invisible(suppressPackageStartupMessages(lapply(packages, library, character.only = TRUE)))
source(file.path("utils.R"))
conflict_prefer("rowMedians", "Biobase", quiet = TRUE)
conflict_prefer("which", "BiocGenerics", quiet = TRUE)
conflict_prefer("select", "dplyr", quiet = TRUE)
conflict_prefer("intersect", "base", quiet = TRUE)
conflict_prefer("cbind", "mice", quiet = TRUE)

data_name <- "oxford-ms-data-april-2022"
`%notin%` <- Negate(`%in%`)

heatmap_color <- colorRamp2(c(-1, 0, 1), c("#0077BB", "#FFFFFF", "#CC3311"))
# --------------------------------------------

# Everything else in this chunk remains generally unchanged.
# ----------------------------------------------------------
assets_dir <- file.path("..", "assets") # Backed up data.

cache_dir <- file.path("..", "tmp", "cache", data_name, "imputation-simulation")
if (!dir.exists(cache_dir)) {
  dir.create(cache_dir, recursive = TRUE)
}

knitr::opts_chunk$set(fig.width = 10, fig.height = 7, dpi = 300)
# ----------------------------------------------------------
# --------------------------
```

# Prep

Read in the data and organize into a `SummarizedExperiment` object.

```{r}
data <- read.delim(file.path(assets_dir, data_name, "20220404_DOB_AllPatients_v1.pg_matrix.tsv"))
tmp1 <- data[ , 1:5]
tmp2 <- as.data.frame(data[ , 6])
colnames(tmp2) <- colnames(data)[6]
tmp3 <- data[ , 7:14]
tmp4 <- data[ , 15:ncol(data)]
data <- cbind(tmp1, tmp3, tmp2, tmp4)
rm(tmp1, tmp2, tmp3, tmp4)

data2 <- read_xlsx(
  file.path(assets_dir, data_name, "20220405_MSQ2321_StephanieFowler_DOB_EV64.xlsx")
)
colnames(data) <- c(colnames(data)[1:5], colnames(data2)[5:ncol(data2)])
rm(data2)

remove <- which(
  colnames(data) == "5521 F8" | colnames(data) == "5365 F8" | colnames(data) == "5333 F8"
)
data <- data[ , -remove]

remove <- which(data$Genes == "")
data <- data[-remove, ]

data$gene_names <- data$Genes
data <- make_unique(data, "gene_names", "Protein.Ids", ";")

LFQ_columns <- 6:66
data <- data[
  , c(
      1:5, (order(substring(colnames(data)[LFQ_columns], nchar(colnames(data))[LFQ_columns])) + 5),
      67:ncol(data)
    )
]

experimental_design <- data.frame(
  label = colnames(data)[6:66],
  condition = paste0(
    "Fraction ", substring(colnames(data)[LFQ_columns], nchar(colnames(data))[LFQ_columns])
  ),
  replicate = c(rep(1:8, 7), 2:4, 7:8),
  donor = sub(" .*", "", colnames(data)[6:66])
)
experimental_design$nice_names <- sub(
  "\\.", " ", paste(experimental_design$condition, experimental_design$donor, sep = " ")
)
experimental_design$groups <- c(rep("F1_3", 24), rep("F4_6", 24), rep("F7_8", 13))

limma_design <- model.matrix(~ 0 + experimental_design$groups)
colnames(limma_design) <- unique(experimental_design$groups)
contrast_mat <- makeContrasts(F1_3-F4_6, F1_3-F7_8, F4_6-F7_8, levels = limma_design)

colour <- colour("vibrant")(7)
colour <- append("#DDAA33", colour)
colour <- colour[c(1, 2, 5, 3, 4, 7, 6, 8)]
names(colour) <- unique(sub("\\.", " ", experimental_design$condition))

data <- make_se(data, LFQ_columns, experimental_design)
data
```

# Simulate Data

```{r}
mu <- rowMeans(assay(data), TRUE)
std <- apply(assay(data), 1, sd, na.rm = TRUE)
discard <- which(is.na(std))
std <- std[-discard]
mu <- mu[-discard]
set.seed(1)
sim_data <- suppressWarnings(
  t(as.data.frame(mapply(function(x, y) rnorm(ncol(data), x, y), mu, std)))
)
colnames(sim_data) <- colnames(data)

hist(sim_data, n = 100)

idx <- 1
for (group in unique(data$groups)) {
  for (i in idx:(idx + 999)) {
    sim_data[i, which(data$groups != group)] <- sim_data[i, which(data$groups != group)] / 2
  }
  idx <- idx + 1000
}

hist(sim_data, n = 100)

set.seed(1)
amp_MAR <- ampute(sim_data, 0.2, mech = "MAR")
set.seed(1)
amp_MNAR <- ampute(sim_data, 0.8, mech = "MNAR")

set.seed(1)
idx <- sample(c(1, 2), nrow(data), TRUE, c(0.5, 0.5))

amp_data <- matrix(nrow = nrow(data), ncol = ncol(data))
amp_data[idx == 1, ] <- as.matrix(amp_MAR$amp[idx == 1, ])
amp_data[idx == 2, ] <- as.matrix(amp_MNAR$amp[idx == 2, ])

colnames(amp_data) <- colnames(data)
rownames(amp_data) <- rownames(data)
assay(data) <- amp_data
rm(sim_data, sim_list, amp_data, amp_MAR, amp_MNAR)
data

hist(assay(data), n = 100)

unimputed_data <- data # Keep an object that won't go through the imputation process.
complete_cases <- filter_proteins(data, "complete") # Keep another object with only complete values.
```

**Unaltered data, already log2 transformed**

```{r}
datatable <- assay(data)
colnames(datatable) <- data$nice_names

datatable_download(datatable)
```

# References

This is the concluding section of the document, where we output the `sessionInfo`, and create a bibliography for works cited.

```{r}
sessionInfo()
```
