---
title: "Zetaview Analysis"
author:
  - name: "Emir, Pal, and Steph"
date: '`r strftime(Sys.time(), "%B %d, %Y")`'
bibliography: "../AD-CBD-exosome-proteins.bib"
link-citations: true
output:
  html_document:
    code_folding: hide
    number_sections: true
    theme: lumen
    highlight: haddock
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: false
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(
    "..", "results", "zetaview-analysis.html"
  ))})
---

<style type="text/css">
body {font-size: 16px;}
h1.title {font-size: 35px;}
h1 {font-size: 24px;}
h2 {font-size: 22px;}
h3 {font-size: 20px;}
.toc-content {padding-left: 0px; padding-right: 0px;}
div.tocify {width: 100%;}
.tocify-subheader .tocify-item {font-size: 0.95em; padding-left: 25px; text-indent: 0;}
.tocify-subheader .tocify-subheader .tocify-item {
  font-size: 0.95em; padding-left: 35px; text-indent: 0;
}
div.main-container {max-width: none; width: 100%;}
</style>

*This file is a part of [AD-CBD-exosome-proteins](https://github.com/eturkes/AD-CBD-exosome-proteins).*
*Please email for access.*

The data here will be referenced using the name `zetaview`.
It is particle count data from ZetaView of exosomes derived from post-mortem brains of 7 donors with Alzheimer's Disease (AD).
Exosomes were fractionated into 8 fractions (plus 10k pellet, which are excluded from downstream analysis) for each donor.
Three technical replicates per fraction was run through the Zetaview.

```{r}
# Some standard boilerplate.
# --------------------------
# Copyright 2019-2022 Emir Turkes, Guar Pallavi, Stephanie Fowler, UK DRI at UCL, Columbia
# University Medical Center
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
#     http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# This section should be checked per document.
# --------------------------------------------
packages <- c("conflicted", "DT", "ggplot2", "reshape2")
invisible(suppressPackageStartupMessages(lapply(packages, library, character.only = TRUE)))
source(file.path("utils.R"))

data_name <- "zetaview"
`%notin%` <- Negate(`%in%`)
# --------------------------------------------

# Everything else in this chunk remains generally unchanged.
# ----------------------------------------------------------
assets_dir <- file.path("..", "assets") # Backed up data.

cache_dir <- file.path("..", "tmp", "cache", data_name)
if (!dir.exists(cache_dir)) {
  dir.create(cache_dir, recursive = TRUE)
}

knitr::opts_chunk$set(fig.width = 10, fig.height = 7, dpi = 300)
# ----------------------------------------------------------
# --------------------------
```

# Prep

The data is spread out across many files, so we first aggregate them to obtain a single data object with counts per particle size.
We also create variations of this object that are aggregated by the mean of values by donor and fraction as well as various normalisation schemes found in following sections.

```{r}
file_list <- list.files(file.path(assets_dir, data_name, "raw-data"))
file_list <- file_list[-grep("10K", file_list)] # Remove 10K pellets.

data <- data.frame(matrix(nrow = 1200, ncol = length(file_list)) + 1)

for (i in seq_along(file_list)) {
  file <- read.delim(
    file.path(assets_dir, data_name, "raw-data", file_list[i]), skip = 70
  )
  if (i == 1) {
    data[ , i] <- file[1:1200, 1]
  }
  data[ , i + 1] <- file[1:1200, 2]
}

colnames(data) <- c(
  "size",
    paste(
      sub("^[^_]*_[^_]*_([^_]*).*", "\\1", file_list),
      sub("^[^_]*_[^_]*_[^_]*_([^_]*).*", "\\1", file_list),
      sub("^[^_]*_[^_]*_[^_]*_[^_]*_[^_]*_([^_]*).*", "\\1", file_list),
      sep = "_"
  )
)

non_zero <- which(rowSums(data[ , -1]) > 0)
data <- data[min(non_zero):max(non_zero), ]

# Scaling factor based on tissue amount used.
# -------------------------------------------
scaling_factor <- data.frame(amount = c(1.29, 1.21, 1.19, 1.05, 1.01, 1.15, 1.2))
scaling_factor <- min(scaling_factor, na.rm = TRUE) / scaling_factor
rownames(scaling_factor) <- unique(sub("^([^_]*).*", "\\1", colnames(data[ , -1])))
# -------------------------------------------

data_scaled <- data
for (i in seq_along(rownames(scaling_factor))) {
  for (j in seq_along(colnames(data_scaled))) {
    if (sub("^([^_]*).*", "\\1", colnames(data))[j] == rownames(scaling_factor)[i])
      data_scaled[j] <- data_scaled[j] * scaling_factor[i, ]
  }
}

# Scaling factor derived from data to ensure each sample has the same number of total counts.
# -------------------------------------------------------------------------------------------
scaling_factor <- data.frame(factor = max(colSums(data[ ,-1])) / colSums(data[ ,-1]))
rownames(scaling_factor) <- colnames(data[ , -1])
# -------------------------------------------------------------------------------------------

data_norm <- data
for (i in seq_along(rownames(scaling_factor))) {
  for (j in seq_along(colnames(data_norm))) {
    if (colnames(data)[j] == rownames(scaling_factor)[i])
      data_norm[j] <- data_norm[j] * scaling_factor[i, ]
  }
}

names <- unique(sub("_[^_]+$", "", colnames(data[ , -1])))
donor_fraction_data <- data.frame(matrix(nrow = nrow(data), ncol = length(names) + 1))
donor_fraction_data$X1 <- data$size
for (i in seq_along(names)) {
  data_sub <- data[ , which(sub("_[^_]+$", "", colnames(data)) %in% names[i])]
  donor_fraction_data[ , i + 1] <- rowMeans(data_sub)
}
colnames(donor_fraction_data) <- c("size", names)

names <- unique(sub("_[^_]+$", "", colnames(data_scaled[ , -1])))
donor_fraction_data_scaled <- data.frame(matrix(nrow = nrow(data_scaled), ncol = length(names) + 1))
donor_fraction_data_scaled$X1 <- data_scaled$size
for (i in seq_along(names)) {
  data_sub <- data_scaled[ , which(sub("_[^_]+$", "", colnames(data_scaled)) %in% names[i])]
  donor_fraction_data_scaled[ , i + 1] <- rowMeans(data_sub)
}
colnames(donor_fraction_data_scaled) <- c("size", names)

names <- unique(sub("_[^_]+$", "", colnames(data_norm[ , -1])))
donor_fraction_data_norm <- data.frame(matrix(nrow = nrow(data_norm), ncol = length(names) + 1))
donor_fraction_data_norm$X1 <- data_norm$size
for (i in seq_along(names)) {
  data_sub <- data_norm[ , which(sub("_[^_]+$", "", colnames(data_norm)) %in% names[i])]
  donor_fraction_data_norm[ , i + 1] <- rowMeans(data_sub)
}
colnames(donor_fraction_data_norm) <- c("size", names)

names <- unique(sub("^([^_]*).*", "\\1", colnames(data[ , -1])))
donor_data <- data.frame(matrix(nrow = nrow(data), ncol = length(names) + 1))
donor_data$X1 <- data$size
for (i in seq_along(names)) {
  data_sub <- data[ , which(sub("^([^_]*).*", "\\1", colnames(data)) %in% names[i])]
  donor_data[ , i + 1] <- rowMeans(data_sub)
}
colnames(donor_data) <- c("size", names)

names <- unique(sub("^([^_]*).*", "\\1", colnames(data_scaled[ , -1])))
donor_data_scaled <- data.frame(matrix(nrow = nrow(data_scaled), ncol = length(names) + 1))
donor_data_scaled$X1 <- data_scaled$size
for (i in seq_along(names)) {
  data_sub <- data_scaled[ , which(sub("^([^_]*).*", "\\1", colnames(data_scaled)) %in% names[i])]
  donor_data_scaled[ , i + 1] <- rowMeans(data_sub)
}
colnames(donor_data_scaled) <- c("size", names)

names <- unique(sub("^([^_]*).*", "\\1", colnames(data_norm[ , -1])))
donor_data_norm <- data.frame(matrix(nrow = nrow(data_norm), ncol = length(names) + 1))
donor_data_norm$X1 <- data_norm$size
for (i in seq_along(names)) {
  data_sub <- data_norm[ , which(sub("^([^_]*).*", "\\1", colnames(data_norm)) %in% names[i])]
  donor_data_norm[ , i + 1] <- rowMeans(data_sub)
}
colnames(donor_data_norm) <- c("size", names)

names <- unique(sub("^[^_]*_([^_]*).*", "\\1", colnames(data[ , -1])))
fraction_data <- data.frame(matrix(nrow = nrow(data), ncol = length(names) + 1))
fraction_data$X1 <- data$size
for (i in seq_along(names)) {
  data_sub <- data[ , which(sub("^[^_]*_([^_]*).*", "\\1", colnames(data)) %in% names[i])]
  fraction_data[ , i + 1] <- rowMeans(data_sub)
}
colnames(fraction_data) <- c("size", names)

names <- unique(sub("^[^_]*_([^_]*).*", "\\1", colnames(data_scaled[ , -1])))
fraction_data_scaled <- data.frame(matrix(nrow = nrow(data_scaled), ncol = length(names) + 1))
fraction_data_scaled$X1 <- data_scaled$size
for (i in seq_along(names)) {
  data_sub <- data_scaled[
    , which(sub("^[^_]*_([^_]*).*", "\\1", colnames(data_scaled)) %in% names[i])
  ]
  fraction_data_scaled[ , i + 1] <- rowMeans(data_sub)
}
colnames(fraction_data_scaled) <- c("size", names)

names <- unique(sub("^[^_]*_([^_]*).*", "\\1", colnames(data_norm[ , -1])))
fraction_data_norm <- data.frame(matrix(nrow = nrow(data_norm), ncol = length(names) + 1))
fraction_data_norm$X1 <- data_norm$size
for (i in seq_along(names)) {
  data_sub <- data_norm[
    , which(sub("^[^_]*_([^_]*).*", "\\1", colnames(data_norm)) %in% names[i])
  ]
  fraction_data_norm[ , i + 1] <- rowMeans(data_sub)
}
colnames(fraction_data_norm) <- c("size", names)
```

# Distribution Plots

We only plot sizes up to 300nm as counts quickly approach zero from there.
Data objects without any limit on size are also provided for browsing and download.

## All Data

### Unnormalised

```{r}
data_sub <- data[1:which(data$size == 297.5), ]
molten_data <- melt(data_sub[ , -1], id.vars = NULL)
colnames(molten_data) <- c("sample", "frequency")
molten_data$size <- rep(data_sub$size, ncol(data_sub) - 1)

datatable_download(data)
```

**Smoothed**

```{r}
ggplot(molten_data, aes(size, frequency, color = sample)) +
  geom_smooth() +
  theme_light() +
  theme(legend.position = "none")
```

**Without Smoothing**

```{r}
ggplot(molten_data, aes(size, frequency, color = sample)) +
  geom_line() +
  theme_light() +
  theme(legend.position = "none")
```

### Normalised By Tissue Amount

```{r}
data_sub <- data_scaled[1:which(data_scaled$size == 297.5), ]
molten_data <- melt(data_sub[ , -1], id.vars = NULL)
colnames(molten_data) <- c("sample", "frequency")
molten_data$size <- rep(data_sub$size, ncol(data_sub) - 1)

datatable_download(data_scaled)
```

**Smoothed**

```{r}
ggplot(molten_data, aes(size, frequency, color = sample)) +
  geom_smooth() +
  theme_light() +
  theme(legend.position = "none")
```

**Without Smoothing**

```{r}
ggplot(molten_data, aes(size, frequency, color = sample)) +
  geom_line() +
  theme_light() +
  theme(legend.position = "none")
```

### Normalised By Total Counts

```{r}
data_sub <- data_norm[1:which(data_norm$size == 297.5), ]
molten_data <- melt(data_sub[ , -1], id.vars = NULL)
colnames(molten_data) <- c("sample", "frequency")
molten_data$size <- rep(data_sub$size, ncol(data_sub) - 1)

datatable_download(data_norm)
```

**Smoothed**

```{r}
ggplot(molten_data, aes(size, frequency, color = sample)) +
  geom_smooth() +
  theme_light() +
  theme(legend.position = "none")
```

**Without Smoothing**

```{r}
ggplot(molten_data, aes(size, frequency, color = sample)) +
  geom_line() +
  theme_light() +
  theme(legend.position = "none")
```

## Donor by Fraction

### Unnormalised

```{r}
data_sub <- donor_fraction_data[1:which(donor_fraction_data$size == 297.5), ]
molten_data <- melt(data_sub[ , -1], id.vars = NULL)
colnames(molten_data) <- c("sample", "frequency")
molten_data$size <- rep(data_sub$size, ncol(data_sub) - 1)

datatable_download(donor_fraction_data)
```

**Smoothed**

```{r}
ggplot(molten_data, aes(size, frequency, color = sample)) +
  geom_smooth() +
  theme_light()
```

**Without Smoothing**

```{r}
ggplot(molten_data, aes(size, frequency, color = sample)) +
  geom_line() +
  theme_light()
```

### Normalised By Tissue Amount

```{r}
data_sub <- donor_fraction_data_scaled[1:which(donor_fraction_data_scaled$size == 297.5), ]
molten_data <- melt(data_sub[ , -1], id.vars = NULL)
colnames(molten_data) <- c("sample", "frequency")
molten_data$size <- rep(data_sub$size, ncol(data_sub) - 1)

datatable_download(donor_fraction_data_scaled)
```

**Smoothed**

```{r}
ggplot(molten_data, aes(size, frequency, color = sample)) +
  geom_smooth() +
  theme_light()
```

**Without Smoothing**

```{r}
ggplot(molten_data, aes(size, frequency, color = sample)) +
  geom_line() +
  theme_light()
```

### Normalised By Total Counts

```{r}
data_sub <- donor_fraction_data_scaled[1:which(donor_fraction_data_norm$size == 297.5), ]
molten_data <- melt(data_sub[ , -1], id.vars = NULL)
colnames(molten_data) <- c("sample", "frequency")
molten_data$size <- rep(data_sub$size, ncol(data_sub) - 1)

datatable_download(donor_fraction_data_norm)
```

**Smoothed**

```{r}
ggplot(molten_data, aes(size, frequency, color = sample)) +
  geom_smooth() +
  theme_light()
```

**Without Smoothing**

```{r}
ggplot(molten_data, aes(size, frequency, color = sample)) +
  geom_line() +
  theme_light()
```

## By Donor

### Unnormalised

```{r}
data_sub <- donor_data[1:which(donor_data$size == 297.5), ]
molten_data <- melt(data_sub[ , -1], id.vars = NULL)
colnames(molten_data) <- c("sample", "frequency")
molten_data$size <- rep(data_sub$size, ncol(data_sub) - 1)

datatable_download(donor_data)
```

**Smoothed**

```{r}
ggplot(molten_data, aes(size, frequency, color = sample)) +
  geom_smooth() +
  theme_light()
```

**Without Smoothing**

```{r}
ggplot(molten_data, aes(size, frequency, color = sample)) +
  geom_line() +
  theme_light()
```

### Normalised By Tissue Amount

```{r}
data_sub <- donor_data_scaled[1:which(donor_data_scaled$size == 297.5), ]
molten_data <- melt(data_sub[ , -1], id.vars = NULL)
colnames(molten_data) <- c("sample", "frequency")
molten_data$size <- rep(data_sub$size, ncol(data_sub) - 1)

datatable_download(donor_data_scaled)
```

**Smoothed**

```{r}
ggplot(molten_data, aes(size, frequency, color = sample)) +
  geom_smooth() +
  theme_light()
```

**Without Smoothing**

```{r}
ggplot(molten_data, aes(size, frequency, color = sample)) +
  geom_line() +
  theme_light()
```

### Normalised By Total Counts

```{r}
data_sub <- donor_data_norm[1:which(donor_data_norm$size == 297.5), ]
molten_data <- melt(data_sub[ , -1], id.vars = NULL)
colnames(molten_data) <- c("sample", "frequency")
molten_data$size <- rep(data_sub$size, ncol(data_sub) - 1)

datatable_download(donor_data_norm)
```

**Smoothed**

```{r}
ggplot(molten_data, aes(size, frequency, color = sample)) +
  geom_smooth() +
  theme_light()
```

**Without Smoothing**

```{r}
ggplot(molten_data, aes(size, frequency, color = sample)) +
  geom_line() +
  theme_light()
```

## By Fraction

### Unnormalised

```{r}
data_sub <- fraction_data[1:which(fraction_data$size == 297.5), ]
molten_data <- melt(data_sub[ , -1], id.vars = NULL)
colnames(molten_data) <- c("sample", "frequency")
molten_data$size <- rep(data_sub$size, ncol(data_sub) - 1)

datatable_download(fraction_data)
```

**Smoothed**

```{r}
ggplot(molten_data, aes(size, frequency, color = sample)) +
  geom_smooth(span = 0.1) +
  theme_light()
```

**Without Smoothing**

```{r}
ggplot(molten_data, aes(size, frequency, color = sample)) +
  geom_line() +
  theme_light()
```

### Normalised By Tissue Amount

```{r}
data_sub <- fraction_data_scaled[1:which(fraction_data_scaled$size == 297.5), ]
molten_data <- melt(data_sub[ , -1], id.vars = NULL)
colnames(molten_data) <- c("sample", "frequency")
molten_data$size <- rep(data_sub$size, ncol(data_sub) - 1)

datatable_download(fraction_data_scaled)
```

**Smoothed**

```{r}
ggplot(molten_data, aes(size, frequency, color = sample)) +
  geom_smooth(span = 0.1) +
  theme_light()
```

**Without Smoothing**

```{r}
ggplot(molten_data, aes(size, frequency, color = sample)) +
  geom_line() +
  theme_light()
```

### Normalised By Total Counts

```{r}
data_sub <- fraction_data_norm[1:which(fraction_data_norm$size == 297.5), ]
molten_data <- melt(data_sub[ , -1], id.vars = NULL)
colnames(molten_data) <- c("sample", "frequency")
molten_data$size <- rep(data_sub$size, ncol(data_sub) - 1)

datatable_download(fraction_data_norm)
```

**Smoothed**

```{r}
ggplot(molten_data, aes(size, frequency, color = sample)) +
  geom_smooth(span = 0.1) +
  theme_light()
```

**Without Smoothing**

```{r}
ggplot(molten_data, aes(size, frequency, color = sample)) +
  geom_line() +
  theme_light()
```

# References

This is the concluding section of the document, where we output the `sessionInfo`, and create a bibliography for works cited.

```{r}
sessionInfo()
```
